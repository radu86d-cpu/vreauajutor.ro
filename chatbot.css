<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AjutorBot â€“ Chat AI</title>

  <!-- Stiluri locale -->
  <link rel="stylesheet" href="chatbot.css" />

  <!-- Permite setarea endpoint-ului prin ?api=... sau window.CHATBOT_API_URL -->
  <script>
    (function () {
      const fromQS = new URL(location.href).searchParams.get('api');
      if (fromQS) window.CHATBOT_API_URL = fromQS;
    })();
  </script>
</head>
<body>
  <div class="ajb-container" role="application" aria-label="InterfaÈ›Äƒ chat AjutorBot">
    <div class="ajb-header">
      <h1 class="ajb-title">AjutorBot ðŸ¤–</h1>
    </div>

    <div class="chat-container">
      <div id="chat-box" class="chat-box" aria-live="polite" aria-atomic="false"></div>

      <form class="input-area" id="chat-form" autocomplete="off">
        <label for="user-input" class="sr-only">Mesaj</label>
        <input
          type="text"
          id="user-input"
          placeholder="Scrie mesajul tÄƒu..."
          aria-label="Scrie mesajul tÄƒu"
          required
        />
        <button id="send-btn" type="submit" aria-label="Trimite mesaj">Trimite</button>
      </form>
    </div>
  </div>

  <script>
    // Ordinea de prioritate: window.CHATBOT_API_URL â†’ ?api=â€¦ â†’ implicit Netlify Function
    const API_URL =
      window.CHATBOT_API_URL ||
      new URLSearchParams(location.search).get('api') ||
      '/.netlify/functions/chat';

    const chatBox   = document.getElementById('chat-box');
    const input     = document.getElementById('user-input');
    const form      = document.getElementById('chat-form');
    const sendBtn   = document.getElementById('send-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = (input.value || '').trim();
      if (!message) return;

      appendMessage('Tu', message);
      input.value = '';
      input.focus();
      setSending(true);

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if (!response.ok) {
          throw new Error('Request failed: ' + response.status + ' ' + response.statusText);
        }

        const data = await response.json();
        const botReply = data.reply ?? data.echo ?? 'RÄƒspuns gol de la server.';
        appendMessage('AjutorBot', botReply);
      } catch (err) {
        console.error(err);
        appendMessage('AjutorBot', 'Nu pot contacta serverul. VerificÄƒ endpoint-ul È™i configuraÈ›ia.');
      } finally {
        setSending(false);
      }
    });

    function appendMessage(sender, text) {
      const div = document.createElement('div');
      div.className = 'message ajb-message';
      div.innerHTML = '<strong>' + escapeHTML(sender) + ':</strong> ' + escapeHTML(text);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function setSending(sending) {
      sendBtn.disabled = sending;
      sendBtn.textContent = sending ? 'Se trimiteâ€¦' : 'Trimite';
    }

    function escapeHTML(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>