<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Înscriere furnizor</title>
  <style>
    :root{
      --va-bg:#f6f7f9; --va-card:#fff; --va-text:#0f172a; --va-muted:#64748b;
      --va-primary:#0f62fe; --va-border:#e6e8ec;
      --va-radius:16px; --va-softshadow:0 6px 16px rgba(16,24,40,.06);
      --va-danger:#b00020; --va-success:#1ea759;
    }
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--va-bg);margin:0;color:var(--va-text)}
    .wrap{max-width:1280px;margin:2rem auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:clamp(24px,3vw,32px)}
    .subtitle{color:var(--va-muted);margin-bottom:18px}

    /* GRID 3 coloane */
    #grid{
      display:grid;
      grid-template-columns:320px 300px minmax(0,1fr);
      gap:16px; align-items:start;
    }
    .card{background:var(--va-card);border:1px solid var(--va-border);border-radius:var(--va-radius);box-shadow:var(--va-softshadow)}
    #left,#mid,#right{position:sticky;top:12px;max-height:calc(100vh - 24px);overflow:auto}
    #left{padding:16px}
    #mid{padding:14px}
    #right{padding:0}

    /* form stânga */
    #left h3{margin:0 0 10px;font-size:16px}
    label{display:block;margin:.5rem 0 .25rem;font-weight:600}
    input,select,textarea{width:100%;padding:10px;border:1px solid #dfe3ea;border-radius:12px;transition:border-color .18s,box-shadow .18s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--va-primary);box-shadow:0 0 0 4px rgba(15,98,254,.08)}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

    /* butoane principale */
    button{padding:10px 16px;border:0;border-radius:12px;background:#0f62fe;color:#fff;font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;color:#111;border:1px solid #ddd}
    button[disabled]{cursor:not-allowed}
    /* buton Trimite: gri cât timp e dezactivat */
    #submitBtn:disabled{
      background:#cdd3dd; color:#6b7280; border:1px solid #d1d5db; box-shadow:none;
    }
    .msg{margin-top:10px}

    /* toolbar subcategorii */
    .toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .toolbar .right{display:flex;gap:8px}
    .btn-small{
      background:#fff;border:1px solid #c8cdd6;padding:6px 12px;border-radius:999px;
      font-size:12px;cursor:pointer; color:#0b1220 !important; font-weight:700;
    }
    .btn-small:hover{border-color:var(--va-primary);background:#f6f9ff;color:#0b1220 !important}

    .meta-count{font-size:12px;color:#555}

    /* chips subcategorii */
    #subcats{display:flex;flex-direction:column;gap:8px}
    .chip{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid #e5e7eb;background:#fff;color:#111827;
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;font-size:13px;
      transition:all .18s;
    }
    .chip:hover{background:#f9fbff;border-color:#cfe0ff}
    .chip .badge{background:#eef2ff;color:#173bce;border-radius:999px;padding:2px 8px;font-size:11px;font-weight:800;min-width:20px;text-align:center}
    /* activ: alb + contur albastru */
    .chip.active{border-color:var(--va-primary);box-shadow:0 0 0 3px rgba(15,98,254,.12)}
    /* done: fundal albastru + text alb (are copii bifati) */
    .chip.done{background:var(--va-primary);color:#fff;border-color:var(--va-primary);box-shadow:none}
    .chip.done .badge{background:rgba(255,255,255,.2);color:#fff}

    /* dreapta: sub-subcategorii */
    .right-title{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #eef0f3;font-weight:700}
    .right-title .tools{display:flex;gap:8px;align-items:center}
    .grid-kids{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;padding:10px}
    .kid{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer;font-size:13px;transition:all .18s}
    .kid:hover{background:#fafcff;border-color:#cfe0ff}
    .kid input{margin:0;width:18px;height:18px;accent-color:var(--va-primary)}
    .kid.on{background:#f4f7ff;border-color:#99b7ff;font-weight:700}

    @media (max-width:1100px){#grid{grid-template-columns:300px 280px 1fr}}
    @media (max-width:900px){
      #grid{grid-template-columns:1fr}
      #left,#mid,#right{position:relative;top:0;max-height:none}
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Înscriere furnizor</h1>
    <div class="subtitle">Completează datele și alege serviciile oferite. Bifează minim o opțiune în sub-subcategorii.</div>

    <form id="f" novalidate>
      <section id="grid">
        <!-- STÂNGA: date furnizor -->
        <aside id="left" class="card">
          <h3>Detalii furnizor</h3>

          <label for="company_name">Companie *</label>
          <input id="company_name" required/>

          <label for="service_name">Serviciu *</label>
          <select id="service_name" required>
            <option value="">Alege serviciul</option>
          </select>

          <label for="reg_judet">Județ *</label>
          <select id="reg_judet" required>
            <option value="">Alege județul</option>
          </select>

          <label for="reg_oras">Oraș *</label>
          <select id="reg_oras" required disabled>
            <option value="">Alege orașul</option>
          </select>

          <div class="row-2">
            <div>
              <label for="phone">Telefon</label>
              <input id="phone" placeholder="07..."/>
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="contact@..."/>
            </div>
          </div>

          <label for="description">Descriere</label>
          <textarea id="description" rows="4" placeholder="Ce servicii oferiți, zone acoperite..."></textarea>

          <!-- hidden pentru backend -->
          <input type="hidden" id="subcat">
          <input type="hidden" id="subcat_name">
          <input type="hidden" id="subsub">

          <div class="actions">
            <button type="button" class="btn-outline" onclick="history.back()">Înapoi</button>
            <button type="submit" id="submitBtn" disabled>Trimite</button>
          </div>
          <div class="msg" id="msg" aria-live="polite"></div>
        </aside>

        <!-- MIJLOC: subcategorii -->
        <section id="mid" class="card" hidden>
          <div class="toolbar">
            <strong>Subcategorie <span id="subcat-count" class="meta-count"></span></strong>
            <div class="right">
              <button type="button" class="btn-small" id="btn-collapse-sub" aria-expanded="true">Restrânge</button>
              <button type="button" class="btn-small" id="btn-reset">Reset</button>
            </div>
          </div>
          <div id="subcats" role="tablist" aria-label="Subcategorii"></div>
        </section>

        <!-- DREAPTA: sub-subcategorii -->
        <section id="right" class="card" hidden aria-live="polite">
          <div class="right-title">
            <span>Sub-subcategorii (bifează minim 1)</span>
            <div class="tools">
              <button type="button" class="btn-small" id="btn-kids-collapse">Restrânge toate</button>
              <button type="button" class="btn-small" id="btn-kids-expand">Extinde toate</button>
              <small id="min1-hint" style="display:none;color:#b00020;font-weight:700">Selectează cel puțin una</small>
            </div>
          </div>
          <div id="kids"></div>
        </section>
      </section>
    </form>
  </main>

  <!-- === DATA: lists (services, judete/orase) === -->
  <script>
    function fillSelect(sel, arr, firstLabel){
      sel.innerHTML = '';
      const first = document.createElement('option');
      first.value=''; first.textContent=firstLabel; sel.appendChild(first);
      (arr||[]).forEach(v=>{
        const name  = typeof v==='string' ? v : (v.name||v.label||v.text||'');
        const value = typeof v==='string' ? v : (v.value||v.name||v.id||'');
        if (!name) return;
        const o=document.createElement('option'); o.value=value; o.textContent=name; sel.appendChild(o);
      });
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        const r = await fetch('/.netlify/functions/lists?mode=signup', {cache:'no-store'});
        const { services=[], judete=[] } = await r.json();

        const sServ = document.getElementById('service_name');
        const sJ = document.getElementById('reg_judet');
        const sO = document.getElementById('reg_oras');

        fillSelect(sServ, services, 'Alege serviciul');
        fillSelect(sJ, judete,  'Alege județul');
        fillSelect(sO, [],      'Alege orașul'); sO.disabled=true;

        sJ.addEventListener('change', async e=>{
          const judet=e.target.value; fillSelect(sO,[], 'Alege orașul'); sO.disabled=true;
          if (!judet) return;
          const rr = await fetch('/.netlify/functions/lists?mode=signup&judet='+encodeURIComponent(judet), {cache:'no-store'});
          const { orase=[] } = await rr.json();
          fillSelect(sO, orase, 'Alege orașul'); sO.disabled=false;
          if (sServ.value) loadSubcats();
          updateSubmitState();
        });
        sO.addEventListener('change', ()=>{ if (sServ.value) loadSubcats(); updateSubmitState(); });
        sServ.addEventListener('change', ()=>{ loadSubcats(); updateSubmitState(); });

        // input listeners pentru validare live
        ['company_name','phone','email'].forEach(id=>{
          const el=document.getElementById(id);
          el.addEventListener('input', updateSubmitState);
        });

        if (!sServ.value && services.length){ sServ.value = services[0]; loadSubcats(); }
        updateSubmitState();
      }catch(e){ console.error(e); }
    });
  </script>

  <!-- === SUPABASE submit === -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (async ()=>{
      const env = await fetch('/.netlify/functions/spa_env', {cache:'no-store'}).then(r=>r.json());
      const supa = window.supabase.createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY);

      document.getElementById('f').addEventListener('submit', async ev=>{
        ev.preventDefault();
        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('msg');
        const orig = btn.textContent; btn.disabled=true; btn.textContent='Se trimite...'; msg.textContent='';

        const { data:{session} } = await supa.auth.getSession();
        if (!session?.access_token){
          msg.style.color='#b00020'; msg.textContent='Trebuie să fii autentificat (butonul „Autentificare”).';
          btn.disabled=false; btn.textContent=orig; return;
        }

        const selectedChildIds = Array.from(__state.bySub.values())
          .flatMap(s=>Array.from(s)).map(Number).filter(Number.isFinite);

        const payload = {
          company_name: document.getElementById('company_name').value.trim(),
          service_name: document.getElementById('service_name').value,
          judet:        document.getElementById('reg_judet').value,
          oras:         document.getElementById('reg_oras').value,
          phone:        document.getElementById('phone')?.value || '',
          email:        document.getElementById('email')?.value || '',
          description:  document.getElementById('description')?.value || '',
          subcat:       document.getElementById('subcat').value || null,
          subcat_name:  document.getElementById('subcat_name').value || null,
          subsub:       document.getElementById('subsub').value || null,
          subsubs:      selectedChildIds
        };

        try{
          const r = await fetch('/.netlify/functions/register_provider', {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':'Bearer '+session.access_token},
            body:JSON.stringify(payload)
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.error || 'Eroare necunoscută');
          msg.style.color='#1ea759'; msg.textContent='Înscriere reușită! Mulțumim.';
          ev.target.reset(); document.getElementById('reg_oras').disabled=true;
          document.getElementById('right').hidden=true; document.getElementById('mid').hidden=true;
          __state.bySub.clear(); __meta.clear(); __cacheKids.clear();
          updateSubmitState();
        }catch(e){ msg.style.color='#b00020'; msg.textContent='Eroare: '+e.message; }
        finally{ btn.textContent=orig; }
      });
    })();
  </script>

  <!-- === UI taxonomie (active/done) + VALIDARE SUBMIT === -->
  <script>
    /* STATE */
    const __state = { bySub:new Map() };   // subId -> Set(child string)
    const __meta  = new Map();             // subId -> {btn,badge,name}
    const __cacheKids = new Map();         // subId -> children[]

    /* helpers */
    async function ajx(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    const kidGroupId = subId => 'g_'+String(subId).replace(/[^a-z0-9_-]/gi,'_');
    const setActive = (el,on)=> el && el.classList.toggle('active', !!on);
    const setDone   = (el,on)=> el && el.classList.toggle('done',   !!on);

    function emailValid(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(String(v||'').trim()); }
    function phoneValid(v){ return /^\s*(0\d{9}|\+?\d{7,15})\s*$/.test(String(v||'').trim()); }

    function submitReady(){
      const nameOk = (document.getElementById('company_name').value||'').trim().length>1;
      const serviceOk = !!document.getElementById('service_name').value;
      const judOk = !!document.getElementById('reg_judet').value;
      const orasOk = !!document.getElementById('reg_oras').value;
      const phoneOk = phoneValid(document.getElementById('phone').value);
      const emailOk = emailValid(document.getElementById('email').value);
      const hasSub = __state.bySub.size>0;
      const hasKid = Array.from(__state.bySub.values()).some(s=>s.size>0);
      return nameOk && serviceOk && hasSub && hasKid && judOk && orasOk && phoneOk && emailOk;
    }
    function updateSubmitState(){
      const btn=document.getElementById('submitBtn');
      btn.disabled = !submitReady();
    }

    function syncHidden(){
      const ids=[], names=[];
      for (const [k,set] of __state.bySub.entries()){
        if (!set.size) continue;
        const m=__meta.get(k)||{};
        if (Number.isInteger(k)) ids.push(String(k)); else names.push(m.name||String(k));
      }
      document.getElementById('subcat').value = ids.join(',');
      document.getElementById('subcat_name').value = names.join(',');
      const firstKid = Array.from(__state.bySub.values()).flatMap(s=>Array.from(s))[0];
      document.getElementById('subsub').value = firstKid ? String(firstKid) : '';
      updateSubcatCounter();
      updateSubmitState();
    }

    function updateSubcatCounter(){
      const n = Array.from(__state.bySub.values()).filter(s=>s.size>0).length;
      document.getElementById('subcat-count').textContent = n ? `(${n} selectate)` : '';
    }

    function updateBadge(subId){
      const meta=__meta.get(subId); if(!meta) return;
      const set = __state.bySub.get(subId)||new Set();
      meta.badge.textContent = String(set.size||0);
    }

    /* render subcategorii */
    function renderSubcats(container, items){
      container.innerHTML=''; __meta.clear();
      items.forEach(it=>{
        const id = (it.id!=null) ? Number(it.id) : (it.subcat_id!=null ? Number(it.subcat_id) : String(it.name||it.subcat_name||''));
        const name = it.name ?? it.subcat_name ?? '';

        const btn = document.createElement('button'); btn.type='button'; btn.className='chip';
        btn.setAttribute('role','tab'); btn.setAttribute('aria-controls', kidGroupId(id));

        const title = document.createElement('span'); title.textContent=name; title.style.flex='1';
        const badge = document.createElement('span'); badge.className='badge'; badge.textContent='0';
        btn.appendChild(title); btn.appendChild(badge);

        __meta.set(id,{btn,badge,name});

        const has = (__state.bySub.get(id)?.size||0)>0;
        setDone(btn, has); setActive(btn, false); if (has) badge.textContent=String(__state.bySub.get(id).size);

        btn.addEventListener('click', ()=>toggleKids(id));
        container.appendChild(btn);
      });
      document.getElementById('mid').hidden=false;
      updateSubcatCounter();
      updateSubmitState();
    }

    /* resync checkboxes + stări pe chip */
    function resyncKidsUI(subId){
      const group=document.getElementById(kidGroupId(subId)); if(!group) return;
      const set=__state.bySub.get(subId)||new Set();
      group.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.checked = set.has(String(cb.value));
        cb.closest('.kid')?.classList.toggle('on', cb.checked);
      });
      const chip = (__meta.get(subId)||{}).btn;
      setDone(chip, set.size>0); if (!group.hidden && set.size===0) setActive(chip,true);
      updateBadge(subId); updateSubcatCounter(); updateSubmitState();
    }

    /* toggle deschidere grup copii */
    async function toggleKids(subId){
      document.getElementById('right').hidden=false;
      const cont=document.getElementById('kids');
      const gid=kidGroupId(subId); let g=document.getElementById(gid);
      const chip=(__meta.get(subId)||{}).btn;

      const isOpen = !!g && !g.hidden;
      if (isOpen){ g.hidden=true; setActive(chip,false); return; }

      document.querySelectorAll('#subcats .chip').forEach(c=>{ if(!c.classList.contains('done')) c.classList.remove('active'); });
      if (!chip.classList.contains('done')) setActive(chip,true);

      if (!g){
        const kids = await loadKids(subId);
        const meta = __meta.get(subId)||{};

        g=document.createElement('section'); g.id=gid; g.className='group';

        const head=document.createElement('div'); head.className='right-title';
        head.innerHTML=`<span>${meta.name||('Subcategorie '+subId)}</span>`;
        const tools=document.createElement('div'); tools.className='tools';
        const btn=document.createElement('button'); btn.className='btn-small'; btn.type='button'; btn.textContent='Ascunde';
        btn.addEventListener('click', ()=>{ g.hidden=true; setActive(chip,false); });
        tools.appendChild(btn); head.appendChild(tools); g.appendChild(head);

        const grid=document.createElement('div'); grid.className='grid-kids';

        const setSel = __state.bySub.get(subId)||new Set();
        kids.forEach(k=>{
          const idStr = (k.id!=null) ? String(k.id) : (k.name||'');
          const row=document.createElement('label'); row.className='kid'+(setSel.has(idStr)?' on':'');
          const cb=document.createElement('input'); cb.type='checkbox'; cb.value=idStr; cb.checked=setSel.has(idStr);
          cb.addEventListener('change', ()=>{
            let set=__state.bySub.get(subId); if(!set){ set=new Set(); __state.bySub.set(subId,set); }
            if (cb.checked) set.add(idStr); else set.delete(idStr);
            if (set.size===0) __state.bySub.delete(subId);
            row.classList.toggle('on', cb.checked);
            const has = (set.size>0);
            setDone(chip,has); if (!has) setActive(chip,true);
            updateBadge(subId); syncHidden();
            if (Array.from(__state.bySub.values()).some(s=>s.size>0)) document.getElementById('min1-hint').style.display='none';
          });
          row.appendChild(cb); row.appendChild(document.createTextNode(' '+k.name+(k.count?` (${k.count})`:'')));
          grid.appendChild(row);
        });
        g.appendChild(grid);
        cont.appendChild(g);
      }

      document.querySelectorAll('#kids .group').forEach(el=> el.hidden = (el.id!==gid));
      g.hidden=false; resyncKidsUI(subId);
    }

    async function loadKids(subId){
      if (__cacheKids.has(subId)) return __cacheKids.get(subId);
      const meta=__meta.get(subId)||{};
      const judet=document.getElementById('reg_judet')?.value||'';
      const oras =document.getElementById('reg_oras')?.value||'';
      const subParam = Number.isInteger(subId)?String(subId):(meta.name||String(subId));
      const url='/.netlify/functions/taxonomy?mode=children&subcat='+encodeURIComponent(subParam)
               +(judet?('&judet='+encodeURIComponent(judet)):'')
               +(oras?('&oras='+encodeURIComponent(oras)):'');
      const {children=[]}=await ajx(url);
      __cacheKids.set(subId, children); return children;
    }

    async function loadSubcats(){
      const service=document.getElementById('service_name')?.value||'';
      const judet=document.getElementById('reg_judet')?.value||'';
      const oras =document.getElementById('reg_oras')?.value||'';
      const wrap=document.getElementById('mid'); const cont=document.getElementById('subcats');
      const rc=document.getElementById('right'); const kids=document.getElementById('kids');

      document.getElementById('subcat').value=''; document.getElementById('subcat_name').value='';
      document.getElementById('subsub').value=''; __state.bySub.clear(); __meta.clear(); __cacheKids.clear();
      rc.hidden=true; kids.innerHTML='';
      updateSubmitState();

      if (!service){ wrap.hidden=true; cont.innerHTML=''; return; }
      const url='/.netlify/functions/taxonomy?mode=subcategories&service='+encodeURIComponent(service)
               +(judet?('&judet='+encodeURIComponent(judet)):'')
               +(oras?('&oras='+encodeURIComponent(oras)):'');
      try{
        const { subcategories=[] } = await ajx(url);
        if (!subcategories.length){ wrap.hidden=true; cont.innerHTML=''; return; }
        renderSubcats(cont, subcategories); wrap.hidden=false;
      }catch(e){ console.error(e); wrap.hidden=true; }
    }

    /* Validare la submit: minim 1 copil dacă există subcategorie selectată */
    document.getElementById('f').addEventListener('submit', ev=>{
      const hasAnySub = __state.bySub.size>0;
      const hasAnyKid = Array.from(__state.bySub.values()).some(s=>s.size>0);
      if (hasAnySub && !hasAnyKid){
        ev.preventDefault();
        const hint=document.getElementById('min1-hint');
        hint.style.display='inline';
        document.getElementById('right').scrollIntoView({behavior:'smooth',block:'center'});
      }
    }, true);

    /* Butoane utilitare */
    document.getElementById('btn-reset')?.addEventListener('click', ()=>{
      __state.bySub.clear();
      for (const {btn,badge} of __meta.values()){ setActive(btn,false); setDone(btn,false); if (badge) badge.textContent='0'; }
      document.getElementById('kids').innerHTML=''; document.getElementById('right').hidden=true;
      document.getElementById('subcat').value=''; document.getElementById('subcat_name').value=''; document.getElementById('subsub').value='';
      updateSubcatCounter(); updateSubmitState();
    });
    document.getElementById('btn-collapse-sub')?.addEventListener('click', (e)=>{
      const mid=document.getElementById('mid'); const collapsed=mid.classList.toggle('collapsed');
      e.target.textContent = collapsed ? 'Extinde' : 'Restrânge';
      e.target.setAttribute('aria-expanded', String(!collapsed));
      mid.querySelector('#subcats').style.display = collapsed ? 'none' : '';
    });
    document.getElementById('btn-kids-collapse')?.addEventListener('click', ()=>{
      document.querySelectorAll('#kids .group').forEach(g=> g.hidden=true);
      document.querySelectorAll('#subcats .chip').forEach(c=> c.classList.remove('active'));
    });
    document.getElementById('btn-kids-expand')?.addEventListener('click', ()=>{
      document.querySelectorAll('#kids .group').forEach(g=> g.hidden=false);
    });
  </script>
</body>
</html>
