<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Înscriere furnizor</title>
  <style>
    :root{
      --bg:#f6f7f9;--card:#fff;--text:#0f172a;--muted:#64748b;--primary:#0f62fe;--primary-100:#eef4ff;--border:#e6e8ec;--radius:14px;--shadow:0 10px 28px rgba(16,24,40,.08);--soft:0 5px 16px rgba(16,24,40,.06);--danger:#b00020;--success:#1ea759
    }
    html,body{height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#f2f5f9 0%,#fff 100%);color:var(--text);margin:0}
    .wrap{max-width:1280px;margin:1.2rem auto;background:var(--card);padding:18px;border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow)}
    h1{margin:0 0 .4rem;font-size:clamp(22px,3vw,30px);letter-spacing:-.02em}
    .subtitle{color:var(--muted);margin-bottom:14px;font-size:14px}

    label{display:block;margin:.45rem 0 .25rem;font-weight:600;font-size:14px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #dfe3ea;border-radius:10px;background:#fff;font-size:14px;transition:border-color .18s,box-shadow .18s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(15,98,254,.08)}
    textarea{resize:vertical}

    .row{display:flex;gap:8px;align-items:center}
    .hint{font-size:12px;margin-top:4px}
    .hint-danger{color:var(--danger);font-weight:700}
    .hint-ok{color:var(--success);font-weight:700}

    button{padding:9px 14px;border:0;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer;font-weight:700;box-shadow:var(--soft);transition:filter .15s,transform .05s;font-size:13px}
    button:hover{filter:brightness(1.02)}
    button:active{transform:translateY(1px)}
    button[disabled]{opacity:1;cursor:not-allowed;background:#d1d5db;color:#6b7280;box-shadow:none}
    .btn-outline{background:#fff;color:#111;border:1px solid #dfe3ea}
    .btn-small{background:#fff;color:#111;border:1px solid #dfe3ea;padding:5px 10px;border-radius:999px;font-size:12px;line-height:1.2;cursor:pointer}
    .btn-small:hover{border-color:var(--primary);background:#f6f9ff}

    /* ====== 3 coloane: stânga (date), mijloc (subcateg), dreapta (copii) ====== */
    .grid-main{display:grid;grid-template-columns:320px 360px 1fr;gap:16px;align-items:start}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--soft)}

    /* subcategorii pe mijloc ca listă */
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .meta-count{font-size:12px;color:var(--muted)}
    #subcats{display:flex;flex-direction:column;gap:8px}
    .chip{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid #e5e7eb;padding:10px;border-radius:12px;background:#fff;color:#111827;cursor:pointer;font-size:14px;font-weight:600;transition:border-color .18s,background .18s,box-shadow .18s}
    .chip:hover{background:#f9fbff;border-color:#cfe0ff;box-shadow:0 4px 12px rgba(16,24,40,.08)}
    .chip.blue{background:var(--primary-100);color:#173bce;border-color:#b8ccff}
    .chip .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip .badge{background:#eef2ff;color:#173bce;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:800;min-width:20px;text-align:center}
    .chip[disabled]{opacity:.65;cursor:not-allowed;filter:grayscale(.1)}

    /* copii în dreapta */
    #child-wrap[hidden]{display:none}
    #children{display:flex;flex-direction:column;gap:12px}
    .child-group{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .child-title{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef0f3;font-weight:700;font-size:14px;background:#fafbff}
    .child-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;padding:10px}
    .child-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:14px;transition:border-color .18s,box-shadow .18s,background .18s;box-shadow:0 1px 0 rgba(0,0,0,.02);cursor:pointer}
    .child-item:hover{border-color:#cfe0ff;background:#fafcff;box-shadow:0 6px 16px rgba(16,24,40,.06)}
    .child-item input{margin:0;width:18px;height:18px;accent-color:var(--primary)}
    .child-item.on{background:#f4f7ff;border-color:#99b7ff;box-shadow:0 8px 20px rgba(23,59,206,.10);font-weight:700}

    .form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .msg{margin-top:8px}

    @media(max-width:1200px){.grid-main{grid-template-columns:300px 320px 1fr}}
    @media(max-width:1024px){.grid-main{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Înscriere furnizor</h1>
    <div class="subtitle">Completează datele, alege serviciile, verifică telefonul (SMS), apoi trimite. Emailul trebuie doar să fie valid.</div>

    <form id="f" novalidate>
      <section class="grid-main">
        <!-- ===== STÂNGA: date furnizor ===== -->
        <div class="card">
          <label for="company_name">Companie *</label>
          <input id="company_name" autocomplete="organization" required/>

          <label for="service_name">Serviciu *</label>
          <select id="service_name" required>
            <option value="">Alege serviciul</option>
          </select>

          <label for="reg_judet">Județ *</label>
          <select id="reg_judet" required>
            <option value="">Alege județul</option>
          </select>

          <label for="reg_oras">Oraș *</label>
          <select id="reg_oras" required disabled>
            <option value="">Alege orașul</option>
          </select>

          <label for="phone">Telefon *</label>
          <div class="row">
            <input id="phone" placeholder="07..." style="flex:1" inputmode="numeric"/>
            <button type="button" id="btnSendOtp">Trimite cod</button>
          </div>
          <div class="row" style="margin-top:6px">
            <input id="otp_code" placeholder="cod 6 cifre" maxlength="6" style="flex:1" inputmode="numeric"/>
            <button type="button" id="btnVerifyOtp">Verifică</button>
            <span id="phone_status" class="hint"></span>
          </div>

          <label for="email">Email *</label>
          <input id="email" type="email" placeholder="contact@..."/>
          <div id="email_status" class="hint"></div>

          <label for="description">Descriere</label>
          <textarea id="description" rows="3" placeholder="Ce servicii oferiți, zone acoperite..."></textarea>

          <div class="form-actions">
            <button type="button" class="btn-outline" onclick="history.back()">Înapoi</button>
            <button type="submit" id="btnSubmit" disabled>Trimite</button>
          </div>
          <div class="msg" id="msg" role="status" aria-live="polite"></div>
        </div>

        <!-- ===== MIJLOC: Subcategorii (listă) ===== -->
        <div class="card" id="subcats-card">
          <div class="toolbar">
            <div><strong>Subcategorii</strong> <span id="subcat-count-chip" class="meta-count"></span></div>
            <div class="row">
              <button type="button" class="btn-small" id="subcat-reset">Reset</button>
            </div>
          </div>
          <div id="subcats"></div>
        </div>

        <!-- ===== DREAPTA: Copii (sub-subcategorii) ===== -->
        <div class="card" id="child-wrap" hidden>
          <div class="child-title">
            <span>Sub-subcategorii (bifează minim 1)</span>
            <small id="min1-hint" class="hint-danger" style="display:none;margin-left:6px;">Selectează cel puțin una</small>
          </div>
          <div id="children"></div>
        </div>
      </section>

      <!-- hidden pt backend -->
      <input type="hidden" id="subcat">
      <input type="hidden" id="subcat_name">
      <input type="hidden" id="subsub">
    </form>
  </main>

  <!-- Supabase (pt autentificare) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* =================== State & helpers =================== */
    const state = { phoneVerified: false, emailValid: false };

    const __sel = { bySub: new Map() };   // subId -> Set(childIds as strings)
    const __subMeta = new Map();          // subId -> {btn, name, badge}
    const __cacheChildren = new Map();    // subId -> children[]

    // cache persistență selecții pe context (service|judet|oras)
    const __ctxSelections = new Map();
    let __currentCtxKey = null;
    function ctxKeyNow(){
      const s = document.getElementById('service_name')?.value || '';
      const j = document.getElementById('reg_judet')?.value || '';
      const o = document.getElementById('reg_oras')?.value || '';
      return `${s}||${j}||${o}`;
    }
    function saveCurrentCtx(){
      if (!__currentCtxKey) return;
      const clone = new Map();
      for (const [k,set] of __sel.bySub.entries()) clone.set(k, new Set(set));
      __ctxSelections.set(__currentCtxKey, clone);
    }
    function restoreCtxFor(key){
      const saved = __ctxSelections.get(key);
      if (!saved) return false;
      __sel.bySub.clear();
      for (const [k,set] of saved.entries()) __sel.bySub.set(k, new Set(set));
      return true;
    }

    function contextReady(){
      return document.getElementById('service_name').value
          && document.getElementById('reg_judet').value
          && document.getElementById('reg_oras').value;
    }

    async function ajx(url){ const r = await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    function setChipColor(btn, on){ if(btn) btn.classList.toggle('blue', !!on); }
    function childGroupId(subId){ return 'cg_'+String(subId).replace(/[^a-z0-9_\-]/gi,'_'); }
    function ensureChildWrapVisible(){ document.getElementById('child-wrap').hidden=false; }
    function updateSidebarSelectedCount(){ const n = Array.from(__sel.bySub.values()).filter(s=>s.size>0).length; const el = document.getElementById('subcat-count-chip'); if(!el) return; el.textContent = n ? `(${n} selectate)` : ''; }

    function syncHiddenFromState(){
      const ids=[], names=[];
      for (const [key,set] of __sel.bySub.entries()){
        if (!set.size) continue;
        const meta = __subMeta.get(key) || {};
        if (Number.isInteger(key)) ids.push(String(key)); else names.push(meta.name || String(key));
      }
      document.getElementById('subcat').value = ids.join(',');
      document.getElementById('subcat_name').value = names.join(',');
      const firstKid = Array.from(__sel.bySub.values()).flatMap(s=>Array.from(s))[0];
      document.getElementById('subsub').value = firstKid ? String(firstKid) : '';
      updateSidebarSelectedCount();
      recalcSubmitState();
    }

    function renderChips(container, items){
      container.innerHTML=''; __subMeta.clear();
      const ready = contextReady();
      items.forEach(it=>{
        const id = (it.id!=null) ? Number(it.id) : (it.subcat_id!=null ? Number(it.subcat_id) : String(it.name||it.subcat_name||''));
        const name = it.name ?? it.subcat_name ?? '';

        const btn = document.createElement('button');
        btn.type='button'; btn.className='chip'; btn.setAttribute('role','tab'); btn.setAttribute('aria-controls', childGroupId(id));
        if (!ready){ btn.setAttribute('disabled',''); btn.title='Alege județul și orașul pentru a selecta'; }

        const title = document.createElement('span'); title.className='title'; title.textContent=name;
        const badge = document.createElement('span'); badge.className='badge'; badge.textContent='0';
        btn.append(title,badge);

        __subMeta.set(id,{btn,name,badge});

        const has = (__sel.bySub.get(id)?.size||0)>0;
        setChipColor(btn, has);
        if (has) badge.textContent = String(__sel.bySub.get(id).size || 0);

        btn.addEventListener('click', ()=>{ if (!contextReady()) return; toggleChildGroup(id); });
        container.appendChild(btn);
      });
      updateSidebarSelectedCount();
    }

    function updateChipBadge(subId){ const meta = __subMeta.get(subId); if (!meta) return; const set = __sel.bySub.get(subId) || new Set(); meta.badge.textContent = String(set.size || 0); }

    function resyncGroupCheckboxes(subId){
      const group = document.getElementById(childGroupId(subId)); if (!group) return;
      const set = __sel.bySub.get(subId) || new Set();
      group.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked = set.has(String(cb.value)); cb.closest('.child-item')?.classList.toggle('on', cb.checked); });
      const meta = __subMeta.get(subId)||{}; setChipColor(meta.btn, set.size>0); updateChipBadge(subId); updateSidebarSelectedCount(); recalcSubmitState();
    }

    async function toggleChildGroup(subId){
      ensureChildWrapVisible();
      const container = document.getElementById('children');
      const groupId = childGroupId(subId);
      let group = document.getElementById(groupId);
      const chip  = (__subMeta.get(subId)||{}).btn;

      const isOpen = !!group && !group.hidden;
      if (isOpen){ group.hidden = true; return; }

      if (!group){
        const kids = await loadChildren(subId);
        const meta = __subMeta.get(subId) || {};

        group = document.createElement('section'); group.className = 'child-group'; group.id = groupId;
        const title = document.createElement('div'); title.className = 'child-title'; title.appendChild(document.createTextNode(meta.name || ('Subcategorie ' + subId)));
        group.appendChild(title);

        const grid = document.createElement('div'); grid.className = 'child-grid';
        const selectedSet = __sel.bySub.get(subId) || new Set();

        kids.forEach(kid=>{
          const safeKey = (kid.id != null) ? String(kid.id) : ('n_' + (kid.name || '').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,''));
          const inputId = `kid_${subId}_${safeKey}`;

          const lab = document.createElement('label'); lab.className='child-item'; lab.setAttribute('for', inputId);
          const cb  = document.createElement('input'); cb.type='checkbox'; cb.id=inputId; cb.value=(kid.id != null) ? String(kid.id) : (kid.name || '');
          cb.checked = selectedSet.has(String(cb.value)); if (cb.checked) lab.classList.add('on');

          cb.addEventListener('change', ()=>{
            let set = __sel.bySub.get(subId); if (!set){ set = new Set(); __sel.bySub.set(subId, set); }
            const val = String(cb.value);
            if (cb.checked) set.add(val); else set.delete(val);
            if (set.size===0) __sel.bySub.delete(subId);

            lab.classList.toggle('on', cb.checked); setChipColor(chip, set.size>0); updateChipBadge(subId); syncHiddenFromState();
            if (Array.from(__sel.bySub.values()).some(s => s.size > 0)) document.getElementById('min1-hint').style.display = 'none';
            // salvăm imediat selecția în contextul curent
            saveCurrentCtx();
          });

          lab.appendChild(cb);
          lab.appendChild(document.createTextNode(kid.name + (kid.count ? ` (${kid.count})` : '')));
          grid.appendChild(lab);
        });

        group.appendChild(grid);
        container.appendChild(group);
      }

      // ascundem celelalte grupuri, arătăm doar pe cel curent în dreapta
      document.querySelectorAll('#children .child-group').forEach(g=>{ g.hidden = (g.id !== groupId); });
      group.hidden = false;
      resyncGroupCheckboxes(subId);
    }

    async function loadChildren(subId){
      if (__cacheChildren.has(subId)) return __cacheChildren.get(subId);
      const meta = __subMeta.get(subId) || {};
      const judet = document.getElementById('reg_judet')?.value || '';
      const oras  = document.getElementById('reg_oras')?.value || '';
      const subParam = Number.isInteger(subId) ? String(subId) : (meta.name || String(subId));

      const url = '/.netlify/functions/taxonomy?mode=children&subcat=' + encodeURIComponent(subParam)
                + (judet ? '&judet=' + encodeURIComponent(judet) : '')
                + (oras  ? '&oras='  + encodeURIComponent(oras)  : '');
      const { children=[] } = await ajx(url);
      __cacheChildren.set(subId, children);
      return children;
    }

    async function loadSubcatsForSignup(){
      // salvează selecțiile pentru contextul vechi
      saveCurrentCtx();

      const service = document.getElementById('service_name')?.value || '';
      const judet   = document.getElementById('reg_judet')?.value || '';
      const oras    = document.getElementById('reg_oras')?.value || '';
      const cont    = document.getElementById('subcats');
      const childW  = document.getElementById('child-wrap');
      const childC  = document.getElementById('children');

      const newCtx = ctxKeyNow();
      __currentCtxKey = newCtx;

      document.getElementById('subcat').value='';
      document.getElementById('subcat_name').value='';
      document.getElementById('subsub').value='';
      __sel.bySub.clear(); __subMeta.clear(); __cacheChildren.clear();
      childW.hidden=true; childC.innerHTML='';
      updateSidebarSelectedCount();
      recalcSubmitState();

      if (!service){ cont.innerHTML=''; return; }

      const url = '/.netlify/functions/taxonomy?mode=subcategories'
                + '&service=' + encodeURIComponent(service)
                + (judet ? '&judet=' + encodeURIComponent(judet) : '')
                + (oras  ? '&oras='  + encodeURIComponent(oras)  : '');

      try{
        const { subcategories=[] } = await ajx(url);
        if (!subcategories.length){ cont.innerHTML=''; return; }
        renderChips(cont, subcategories);

        // dacă avem selecții salvate pentru contextul curent, le restaurăm
        const restored = restoreCtxFor(newCtx);
        if (restored){
          // re-sincronizează chip-urile și badge-urile
          for (const subId of __sel.bySub.keys()){
            const meta = __subMeta.get(subId);
            if (meta?.btn){ setChipColor(meta.btn, (__sel.bySub.get(subId)?.size||0)>0); updateChipBadge(subId); }
          }
          updateSidebarSelectedCount();
          recalcSubmitState();
        } else if (subcategories.length){
          // altfel, deschide prima subcategorie ca să vadă userul copiii
          const first = (subcategories[0].id!=null) ? Number(subcategories[0].id) : (subcategories[0].subcat_id!=null ? Number(subcategories[0].subcat_id) : String(subcategories[0].name||subcategories[0].subcat_name||''));
          setTimeout(()=>toggleChildGroup(first), 0);
        }
      }catch(e){ console.error(e); }
    }

    /* =================== OTP SMS (Twilio via Netlify Functions) =================== */
    const phoneEl = document.getElementById('phone');
    const otpEl = document.getElementById('otp_code');
    const phoneStatus = document.getElementById('phone_status');

    async function otpStart(){
      const to = phoneEl.value.trim(); if (!to) return;
      phoneStatus.className='hint'; phoneStatus.textContent='Trimit cod...';
      try{
        const r = await fetch('/.netlify/functions/otp_start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ channel:'sms', to }) });
        const txt = await r.text(); let data; try{ data = JSON.parse(txt); } catch{ data = { error: txt }; }
        if (!r.ok || !data.ok){ phoneStatus.className='hint hint-danger'; phoneStatus.textContent = data.error || 'Nu am putut trimite codul.'; return; }
        phoneStatus.className='hint'; phoneStatus.textContent='Cod trimis. Verifică SMS-ul.';
      }catch(e){ phoneStatus.className='hint hint-danger'; phoneStatus.textContent='Eroare rețea.'; }
    }

    async function otpVerify(){
      const to = phoneEl.value.trim(); const code = otpEl.value.trim(); if (!to || !code) return;
      phoneStatus.className='hint'; phoneStatus.textContent='Verific...';
      try{
        const r = await fetch('/.netlify/functions/otp_verify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ channel:'sms', to, code }) });
        const txt = await r.text(); let data; try{ data = JSON.parse(txt); } catch{ data = { error: txt }; }
        if (!r.ok || !data.ok || (data.status && data.status!=='approved')){ state.phoneVerified = false; phoneStatus.className='hint hint-danger'; phoneStatus.textContent = data.error || 'Cod invalid sau expirat.'; recalcSubmitState(); return; }
        state.phoneVerified = true; phoneStatus.className='hint hint-ok'; phoneStatus.textContent='Verificat'; recalcSubmitState();
      }catch(e){ state.phoneVerified = false; phoneStatus.className='hint hint-danger'; phoneStatus.textContent='Eroare verificare.'; recalcSubmitState(); }
    }

    document.getElementById('btnSendOtp').addEventListener('click', otpStart);
    document.getElementById('btnVerifyOtp').addEventListener('click', otpVerify);

    /* =================== Email: doar validare =================== */
    const emailEl = document.getElementById('email');
    const emailStatus = document.getElementById('email_status');
    function emailIsValid(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v); }
    function validateEmail(){
      const v = emailEl.value.trim();
      if (!v){ state.emailValid=false; emailStatus.textContent=''; recalcSubmitState(); return; }
      if (emailIsValid(v)){ state.emailValid=true; emailStatus.className='hint hint-ok'; emailStatus.textContent='Email valid'; }
      else { state.emailValid=false; emailStatus.className='hint hint-danger'; emailStatus.textContent='Email invalid'; }
      recalcSubmitState();
    }
    emailEl.addEventListener('input', validateEmail);

    /* =================== Submit button gating =================== */
    function hasAtLeastOneSubcat(){ return Array.from(__sel.bySub.values()).length>0; }
    function hasAtLeastOneChild(){ return Array.from(__sel.bySub.values()).some(s=>s.size>0); }

    function recalcSubmitState(){
      const company = document.getElementById('company_name').value.trim()!==''; 
      const service = document.getElementById('service_name').value.trim()!=='';
      const judet   = document.getElementById('reg_judet').value.trim()!=='';
      const oras    = document.getElementById('reg_oras').value.trim()!=='';
      const phoneOk = state.phoneVerified && (phoneEl.value.trim()!=='');
      const emailOk = state.emailValid;

      const structuralOk = company && service && judet && oras && hasAtLeastOneSubcat() && hasAtLeastOneChild();
      const finalOk = structuralOk && phoneOk && emailOk;

      const btn = document.getElementById('btnSubmit');
      btn.disabled = !finalOk;

      // comută enable/disable pe chip-uri când se schimbă contextul
      const ready = contextReady();
      for (const {btn:chipBtn} of __subMeta.values()){
        if (!chipBtn) continue;
        if (ready){ chipBtn.removeAttribute('disabled'); chipBtn.removeAttribute('title'); }
        else { chipBtn.setAttribute('disabled',''); chipBtn.title='Alege județul și orașul pentru a selecta'; }
      }
    }

    ['company_name','service_name','reg_judet','reg_oras'].forEach(id=>{
      const el=document.getElementById(id); el.addEventListener('input', recalcSubmitState); el.addEventListener('change', recalcSubmitState);
    });
    phoneEl.addEventListener('input', ()=>{ state.phoneVerified=false; phoneStatus.textContent=''; recalcSubmitState(); });

    /* =================== Bootstrap lists (services, judete, orase) =================== */
    function fillSelect(sel, arr, firstLabel) {
      sel.innerHTML = '';
      const first = document.createElement('option'); first.value = ''; first.textContent = firstLabel; sel.appendChild(first);
      (arr||[]).forEach(v=>{ const name  = typeof v==='string' ? v : (v.name||v.label||v.text||''); const value = typeof v==='string' ? v : (v.value||v.name||v.id||''); if (!name) return; const o=document.createElement('option'); o.value=value; o.textContent=name; sel.appendChild(o); });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const r = await fetch('/.netlify/functions/lists?mode=signup', { cache:'no-store' });
        const { services=[], judete=[] } = await r.json();

        const selServ = document.getElementById('service_name');
        const selJ = document.getElementById('reg_judet');
        const selO = document.getElementById('reg_oras');

        fillSelect(selServ, services, 'Alege serviciul');
        fillSelect(selJ, judete,  'Alege județul');
        fillSelect(selO, [],      'Alege orașul'); selO.disabled=true;

        selJ.addEventListener('change', async (ev)=>{
          const judet=ev.target.value; fillSelect(selO,[], 'Alege orașul'); selO.disabled=true;
          if (!judet) { recalcSubmitState(); return; }
          const rr = await fetch('/.netlify/functions/lists?mode=signup&judet='+encodeURIComponent(judet), {cache:'no-store'});
          const { orase=[] } = await rr.json();
          fillSelect(selO, orase, 'Alege orașul'); selO.disabled=false;
          loadSubcatsForSignup();
          recalcSubmitState();
        });
        selO.addEventListener('change', ()=>{ loadSubcatsForSignup(); recalcSubmitState(); });
        selServ.addEventListener('change', ()=>{ loadSubcatsForSignup(); recalcSubmitState(); });

        // inițializare context
        __currentCtxKey = ctxKeyNow();
        if (!selServ.value && services.length){ selServ.value = services[0]; }
        loadSubcatsForSignup();
      } catch(e){ console.error(e); }

      validateEmail(); // init
      recalcSubmitState();
    });

    /* =================== Submit handler =================== */
    (async () => {
      const envRes = await fetch('/.netlify/functions/spa_env', { cache:'no-store' });
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = await envRes.json();
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      document.getElementById('f').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        recalcSubmitState();
        if (document.getElementById('btnSubmit').disabled) return;

        const form=ev.target, btn=document.getElementById('btnSubmit');
        const originalLabel=btn.textContent;
        btn.disabled=true; btn.setAttribute('aria-busy','true'); btn.textContent='Se trimite...';
        const msg=document.getElementById('msg'); msg.className='msg'; msg.textContent='Trimit...';

        const { data:{session} } = await supa.auth.getSession();
        if (!session?.access_token){
          msg.className='msg hint-danger'; msg.textContent='Trebuie să fii autentificat (butonul „Autentificare”).';
          btn.disabled=false; btn.removeAttribute('aria-busy'); btn.textContent=originalLabel; return;
        }

        const selectedChildIds = Array.from(__sel.bySub.values()).flatMap(s => Array.from(s)).map(v => Number(v)).filter(n => Number.isFinite(n));

        const payload = {
          company_name: document.getElementById('company_name').value.trim(),
          service_name: document.getElementById('service_name').value,
          judet:        document.getElementById('reg_judet').value,
          oras:         document.getElementById('reg_oras').value,
          phone:        document.getElementById('phone').value,
          email:        document.getElementById('email').value,
          description:  document.getElementById('description').value,
          subcat:       document.getElementById('subcat').value || null,
          subcat_name:  document.getElementById('subcat_name').value || null,
          subsub:       document.getElementById('subsub').value || null,
          subsubs:      selectedChildIds
        };

        try{
          const r = await fetch('/.netlify/functions/register_provider', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+session.access_token}, body:JSON.stringify(payload) });
          const data = await r.json();
          if (!r.ok) throw new Error(data.error || 'Eroare necunoscută');
          msg.className='msg hint-ok'; msg.textContent='Înscriere reușită! Mulțumim.';
          form.reset(); document.getElementById('reg_oras').disabled=true; document.getElementById('child-wrap').hidden=true; __sel.bySub.clear(); __subMeta.clear(); __cacheChildren.clear(); state.phoneVerified=false; state.emailValid=false; document.getElementById('phone_status').textContent=''; document.getElementById('email_status').textContent='';
          __ctxSelections.clear(); __currentCtxKey = ctxKeyNow();
        }catch(e){ msg.className='msg hint-danger'; msg.textContent='Eroare: '+e.message; }
        finally{ btn.disabled=false; btn.removeAttribute('aria-busy'); btn.textContent=originalLabel; recalcSubmitState(); }
      });
    })();

    /* UI: butoane secundare */
    document.getElementById('subcat-reset').addEventListener('click', ()=>{
      document.getElementById('subcat').value=''; document.getElementById('subcat_name').value=''; document.getElementById('subsub').value='';
      __sel.bySub.clear(); saveCurrentCtx();
      for (const {btn,badge} of __subMeta.values()){ setChipColor(btn,false); if (badge) badge.textContent='0'; }
      document.getElementById('children').innerHTML='';
      document.getElementById('child-wrap').hidden=true;
      updateSidebarSelectedCount();
      recalcSubmitState();
    });

    // Guard suplimentar: minim 1 copil dacă există măcar o subcategorie selectată
    document.getElementById('f').addEventListener('submit',(ev)=>{
      const hasAnySub = __sel.bySub.size>0; const hasAnyKid = Array.from(__sel.bySub.values()).some(s=>s.size>0);
      if (hasAnySub && !hasAnyKid){ ev.preventDefault(); const hint = document.getElementById('min1-hint'); hint.style.display='inline'; document.getElementById('child-wrap').scrollIntoView({behavior:'smooth', block:'center'}); }
    }, true);
  </script>
</body>
</html>
