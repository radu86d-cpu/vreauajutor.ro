<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Înscriere furnizor</title>
  <style>
    :root{
      --va-bg: #f6f7f9;
      --va-card: #ffffff;
      --va-text: #0f172a;
      --va-muted:#64748b;
      --va-primary:#0f62fe;
      --va-primary-100:#eef4ff;
      --va-border:#e6e8ec;
      --va-radius:14px;
      --va-shadow:0 10px 28px rgba(16,24,40,.08);
      --va-softshadow:0 5px 16px rgba(16,24,40,.06);
      --va-danger:#b00020;
      --va-success:#1ea759;
    }

    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--va-bg);margin:0;color:var(--va-text);}
    .wrap{max-width:1280px;margin:2rem auto;padding:0 16px;}
    h1{margin:0 0 6px;font-size: clamp(24px, 3vw, 32px);}
    .subtitle{color:var(--va-muted);margin-bottom:18px;}

    /* Grid 3 coloane */
    #taxo-grid{
      display:grid;
      grid-template-columns:280px minmax(0,1fr) 320px;
      gap:16px; align-items:start;
    }
    #subcat-wrap,#child-wrap,#vendor-card{
      background:#fff;border:1px solid var(--va-border);border-radius:16px;box-shadow:var(--va-softshadow);
    }
    #subcat-wrap{position:sticky;top:12px;max-height:calc(100vh - 24px);overflow:auto;padding:14px;}
    #child-wrap{position:sticky;top:12px;max-height:calc(100vh - 24px);overflow:auto;}
    #vendor-card{position:sticky;top:12px;padding:16px;}

    /* Toolbar */
    .toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .toolbar .right{display:flex;gap:8px}
    .btn-small{background:#fff;border:1px solid #ddd;padding:6px 12px;border-radius:999px;font-size:12px;cursor:pointer}
    .btn-small:hover{border-color:var(--va-primary);background:#f6f9ff}

    /* Chips */
    #subcats{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .chip{display:flex;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;
      padding:8px 10px;border-radius:10px;background:#fff;font-size:13px;font-weight:600;cursor:pointer;}
    .chip:hover{background:#f9fbff;border-color:#cfe0ff}
    .chip.blue{background:var(--va-primary-100);color:#173bce;border-color:#b8ccff}
    .chip .badge{background:#eef2ff;color:#173bce;border-radius:999px;padding:2px 6px;font-size:11px;font-weight:700;min-width:20px;text-align:center;}

    /* Sub-subcategorii */
    .child-title{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #eef0f3;font-weight:700;font-size:14px}
    .child-title .tools{display:flex;gap:8px;align-items:center}
    .child-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:8px;padding:10px}
    .child-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:13px;cursor:pointer}
    .child-item:hover{background:#fafcff;border-color:#cfe0ff}
    .child-item input{margin:0;width:18px;height:18px;accent-color:var(--va-primary);}
    .child-item.on{background:#f4f7ff;border-color:#99b7ff;font-weight:600}

    /* Formular dreapta */
    #vendor-card h3{margin:0 0 10px;font-size:16px}
    #vendor-card label{display:block;margin:.45rem 0 .25rem;font-weight:600;font-size:14px}
    #vendor-card input,#vendor-card select,#vendor-card textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:12px}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .v-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    button{padding:10px 16px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;border:1px solid #ddd}
    .msg{margin-top:12px}
    .hint-danger{color:var(--va-danger);font-weight:600}
    .hint-ok{color:var(--va-success);font-weight:600}

    @media(max-width:1100px){
      #taxo-grid{grid-template-columns:260px 1fr;}
      #vendor-card{grid-column:1/-1;position:relative;top:0;margin-top:16px}
    }
    @media(max-width:820px){
      #taxo-grid{grid-template-columns:1fr}
      #subcat-wrap,#child-wrap{position:relative;top:0;max-height:none}
      .row-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Înscriere furnizor</h1>
    <div class="subtitle">Completează datele și alege serviciile oferite. Bifează minim o opțiune.</div>

    <form id="f" novalidate>
      <section id="taxo-grid">
        <!-- Stânga -->
        <div id="subcat-wrap" hidden>
          <div class="toolbar">
            <strong>Subcategorie <span id="subcat-count-chip"></span></strong>
            <div class="right">
              <button type="button" class="btn-small" id="subcat-toggle">Restrânge</button>
              <button type="button" class="btn-small" id="subcat-reset">Reset</button>
            </div>
          </div>
          <div id="subcats"></div>
        </div>

        <!-- Mijloc -->
        <div id="child-wrap" hidden>
          <div class="child-title">
            <span>Sub-subcategorii</span>
            <div class="tools">
              <button type="button" class="btn-small" id="children-collapse-all">Restrânge toate</button>
              <button type="button" class="btn-small" id="children-expand-all">Extinde toate</button>
              <small id="min1-hint" class="hint-danger" style="display:none;">Selectează cel puțin una</small>
            </div>
          </div>
          <div id="children"></div>
        </div>

        <!-- Dreapta -->
        <aside id="vendor-card">
          <h3>Detalii furnizor</h3>
          <label for="company_name">Companie *</label>
          <input id="company_name" required>
          <label for="service_name">Serviciu *</label>
          <select id="service_name" required><option value="">Alege serviciul</option></select>
          <label for="reg_judet">Județ *</label>
          <select id="reg_judet" required><option value="">Alege județul</option></select>
          <label for="reg_oras">Oraș *</label>
          <select id="reg_oras" required disabled><option value="">Alege orașul</option></select>
          <div class="row-2">
            <div><label for="phone">Telefon</label><input id="phone" placeholder="07..."></div>
            <div><label for="email">Email</label><input id="email" type="email" placeholder="contact@..."></div>
          </div>
          <label for="description">Descriere</label>
          <textarea id="description" rows="3"></textarea>
          <input type="hidden" id="subcat"><input type="hidden" id="subcat_name"><input type="hidden" id="subsub">
          <div class="v-actions">
            <button type="button" class="btn-outline" onclick="history.back()">Înapoi</button>
            <button type="submit">Trimite</button>
          </div>
          <div id="msg" class="msg"></div>
        </aside>
      </section>
    </form>
  </main>

  <!-- === Scripturi === -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    function fillSelect(sel, arr, firstLabel) {
      sel.innerHTML = '';
      const first = document.createElement('option');
      first.value = ''; first.textContent = firstLabel; sel.appendChild(first);
      (arr||[]).forEach(v=>{
        const name  = typeof v==='string' ? v : (v.name||v.label||v.text||'');
        const value = typeof v==='string' ? v : (v.value||v.name||v.id||'');
        if (!name) return;
        const o=document.createElement('option'); o.value=value; o.textContent=name; sel.appendChild(o);
      });
    }
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const r = await fetch('/.netlify/functions/lists?mode=signup', { cache:'no-store' });
        const { services=[], judete=[] } = await r.json();
        fillSelect(document.getElementById('service_name'), services, 'Alege serviciul');
        fillSelect(document.getElementById('reg_judet'), judete,  'Alege județul');
      } catch(e){ console.error(e); }
    });
  </script>
  <script>
    (async () => {
      const envRes = await fetch('/.netlify/functions/spa_env', { cache:'no-store' });
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = await envRes.json();
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      document.getElementById('f').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const form=ev.target, btn=form.querySelector('button[type="submit"]');
        const originalLabel=btn.textContent;
        btn.disabled=true; btn.textContent='Se trimite...';
        const msg=document.getElementById('msg'); msg.textContent='Trimit...';

        const { data:{session} } = await supa.auth.getSession();
        if (!session?.access_token){
          msg.className='msg hint-danger'; msg.textContent='Trebuie autentificare.';
          btn.disabled=false; btn.textContent=originalLabel; return;
        }
        const selectedChildIds = Array.from(__sel.bySub.values()).flatMap(s => Array.from(s)).map(v => Number(v)).filter(n => Number.isFinite(n));
        const payload = {
          company_name: document.getElementById('company_name').value.trim(),
          service_name: document.getElementById('service_name').value,
          judet:document.getElementById('reg_judet').value,
          oras:document.getElementById('reg_oras').value,
          phone:document.getElementById('phone').value,
          email:document.getElementById('email').value,
          description:document.getElementById('description').value,
          subcat:document.getElementById('subcat').value||null,
          subcat_name:document.getElementById('subcat_name').value||null,
          subsub:document.getElementById('subsub').value||null,
          subsubs:selectedChildIds
        };
        try{
          const r = await fetch('/.netlify/functions/register_provider', {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':'Bearer '+session.access_token},
            body:JSON.stringify(payload)
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.error||'Eroare necunoscută');
          msg.className='msg hint-ok'; msg.textContent='Înscriere reușită!';
          form.reset(); document.getElementById('reg_oras').disabled=true;
          document.getElementById('child-wrap').hidden=true; document.getElementById('subcat-wrap').hidden=true;
          __sel.bySub.clear(); __subMeta.clear(); __cacheChildren.clear();
        }catch(e){ msg.className='msg hint-danger'; msg.textContent='Eroare: '+e.message; }
        finally{ btn.disabled=false; btn.textContent=originalLabel; }
      });
    })();
  </script>
  <script>
    const __sel={bySub:new Map()},__subMeta=new Map(),__cacheChildren=new Map();
    async function ajx(url){const r=await fetch(url,{cache:'no-store'});if(!r.ok)throw new Error(await r.text());return r.json();}
    function setChipColor(btn,on){if(btn)btn.classList.toggle('blue',!!on);}
    function childGroupId(subId){return 'cg_'+String(subId).replace(/[^a-z0-9_\-]/gi,'_');}
    function ensureChildWrapVisible(){document.getElementById('child-wrap').hidden=false;}
    function updateSidebarSelectedCount(){const n=Array.from(__sel.bySub.values()).filter(s=>s.size>0).length;
      document.getElementById('subcat-count-chip').textContent=n?`(${n} selectate)`:'';}
    function renderChips(container,items){container.innerHTML='';__subMeta.clear();items.forEach(it=>{
      const id=(it.id!=null)?Number(it.id):(it.subcat_id!=null?Number(it.subcat_id):String(it.name||it.subcat_name||''));const name=it.name??it.subcat_name??'';
      const btn=document.createElement('button');btn.type='button';btn.className='chip';
      const title=document.createElement('span');title.textContent=name;
      const badge=document.createElement('span');badge.className='badge';badge.textContent='0';btn.append(title,badge);
      __subMeta.set(id,{btn,name,badge});
      btn.addEventListener('click',()=>toggleChildGroup(id));container.appendChild(btn);});
      document.getElementById('subcat-wrap').hidden=false;updateSidebarSelectedCount();}
    function updateChipBadge(subId){const meta=__subMeta.get(subId);if(!meta)return;const set=__sel.bySub.get(subId)||new Set();meta.badge.textContent=String(set.size||0);}
    function resyncGroupCheckboxes(subId){const group=document.getElementById(childGroupId(subId));if(!group)return;const set=__sel.bySub.get(subId)||new Set();
      group.querySelectorAll('input').forEach(cb=>{cb.checked=set.has(String(cb.value));cb.closest('.child-item')?.classList.toggle('on',cb.checked);});
      updateChipBadge(subId);updateSidebarSelectedCount();}
    async function toggleChildGroup(subId){ensureChildWrapVisible();const container=document.getElementById('children');
      const groupId=childGroupId(subId);let group=document.getElementById(groupId);if(group){group.hidden=!group.hidden;return;}
      const kids=await loadChildren(subId);const meta=__subMeta.get(subId)||{};
      group=document.createElement('section');group.className='child-group';group.id=groupId;
      const title=document.createElement('div');title.className='child-title';title.textContent=meta.name;group.appendChild(title);
      const grid=document.createElement('div');grid.className='child-grid';
      kids.forEach(kid=>{const inputId=`kid_${subId}_${kid.id||kid.name}`;const lab=document.createElement('label');lab.className='child-item';lab.setAttribute('for',inputId);
        const cb=document.createElement('input');cb.type='checkbox';cb.id=inputId;cb.value=kid.id||kid.name;cb.addEventListener('change',()=>{
          let set=__sel.bySub.get(subId);if(!set){set=new Set();__sel.bySub.set(subId,set);}
          cb.checked?set.add(cb.value):set.delete(cb.value);if(set.size===0)__sel.bySub.delete(subId);
          lab.classList.toggle('on',cb.checked);updateChipBadge(subId);updateSidebarSelectedCount();});lab.append(cb,document.createTextNode(kid.name));grid.appendChild(lab);});
      group.appendChild(grid);container.appendChild(group);}
    async function loadChildren(subId){if(__cacheChildren.has(subId))return __cacheChildren.get(subId);
      const {children=[]}=await ajx('/.netlify/functions/taxonomy?mode=children&subcat='+encodeURIComponent(subId));__cacheChildren.set(subId,children);return children;}
    async function loadSubcatsForSignup(){const service=document.getElementById('service_name')?.value||'';if(!service){document.getElementById('subcat-wrap').hidden=true;return;}
      const {subcategories=[]}=await ajx('/.netlify/functions/taxonomy?mode=subcategories&service='+encodeURIComponent(service));renderChips(document.getElementById('subcats'),subcategories);}
    document.getElementById('service_name')?.addEventListener('change',loadSubcatsForSignup);
  </script>
</body>
</html>
