<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Înscriere furnizor</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#0f62fe;
      --primary-100:#eef4ff;
      --border:#e6e8ec;
      --radius:14px;
      --shadow:0 10px 28px rgba(16,24,40,.08);
      --soft:0 5px 16px rgba(16,24,40,.06);
      --danger:#b00020;
      --success:#1ea759;
    }
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#f2f5f9 0%,#fff 100%);color:var(--text);margin:0}
    .wrap{max-width:1100px;margin:2rem auto;background:var(--card);padding:22px;border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow)}
    h1{margin:0 0 .5rem;font-size:clamp(24px,3vw,32px);letter-spacing:-.02em}
    .subtitle{color:var(--muted);margin-bottom:18px}

    label{display:block;margin:.6rem 0 .35rem;font-weight:600}
    input,select,textarea{
      width:100%;padding:12px;border:1px solid #dfe3ea;border-radius:12px;background:#fff;
      transition:border-color .18s,box-shadow .18s
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(15,98,254,.08)}
    .row{display:flex;gap:8px;align-items:center}
    .w-auto{width:auto}
    .hint{font-size:12px;margin-top:4px}
    .hint-danger{color:var(--danger);font-weight:700}
    .hint-ok{color:var(--success);font-weight:700}

    button{padding:12px 18px;border:0;border-radius:12px;background:var(--primary);color:#fff;cursor:pointer;font-weight:700;box-shadow:var(--soft);transition:filter .15s,transform .05s}
    button:hover{filter:brightness(1.02)}
    button:active{transform:translateY(1px)}
    button[disabled]{opacity:1;cursor:not-allowed;background:#d1d5db;color:#6b7280;box-shadow:none}

    .btn-outline{background:#fff;color:#111;border:1px solid #dfe3ea}
    .btn-small{background:#fff;color:#111;border:1px solid #dfe3ea;padding:6px 12px;border-radius:999px;font-size:12px;line-height:1.2;min-width:auto;cursor:pointer}
    .btn-small:hover{border-color:var(--primary);background:#f6f9ff}

    .grid-main{display:grid;grid-template-columns:360px 1fr;gap:16px;align-items:start}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--soft)}

    #subcat-wrap{position:sticky;top:12px;max-height:72vh;overflow:auto}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .meta-count{font-size:12px;color:var(--muted)}
    #subcats{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .chip{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid #e5e7eb;padding:10px 12px;border-radius:12px;background:#fff;color:#111827;cursor:pointer;font-size:14px;font-weight:600;transition:border-color .18s,background .18s,box-shadow .18s}
    .chip:hover{background:#f9fbff;border-color:#cfe0ff;box-shadow:0 4px 12px rgba(16,24,40,.08)}
    .chip.blue{background:var(--primary-100);color:#173bce;border-color:#b8ccff}
    .chip .title{flex:1}
    .chip .badge{background:#eef2ff;color:#173bce;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:800;min-width:20px;text-align:center}

    .child-title{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eef0f3;font-weight:700;font-size:14px}
    .child-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;padding:12px}
    .child-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-size:14px;transition:border-color .18s,box-shadow .18s,background .18s;box-shadow:0 1px 0 rgba(0,0,0,.02);cursor:pointer}
    .child-item:hover{border-color:#cfe0ff;background:#fafcff;box-shadow:0 6px 16px rgba(16,24,40,.06)}
    .child-item input{margin:0;width:18px;height:18px;accent-color:var(--primary)}
    .child-item.on{background:#f4f7ff;border-color:#99b7ff;box-shadow:0 8px 20px rgba(23,59,206,.10);font-weight:700}

    .form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .msg{margin-top:10px}

    .status-pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;border-radius:999px;padding:4px 8px}
    .ok{color:#065f46;background:#d1fae5;border:1px solid #10b981}
    .bad{color:#7f1d1d;background:#fee2e2;border:1px solid #ef4444}
    .warn{color:#92400e;background:#fef3c7;border:1px solid #f59e0b}

    @media(max-width:920px){.grid-main{grid-template-columns:1fr}#subcat-wrap{position:relative;top:0}}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Înscriere furnizor</h1>
    <div class="subtitle">Completează datele, alege serviciile oferite, verifică telefonul (SMS), apoi trimite. Emailul trebuie doar să fie valid.</div>

    <form id="f" novalidate>
      <section class="grid-main">
        <!-- STÂNGA: date furnizor -->
        <div class="card">
          <label for="company_name">Companie *</label>
          <input id="company_name" autocomplete="organization" required/>

          <label for="service_name">Serviciu *</label>
          <select id="service_name" required>
            <option value="">Alege serviciul</option>
          </select>

          <label for="reg_judet">Județ *</label>
          <select id="reg_judet" required>
            <option value="">Alege județul</option>
          </select>

          <label for="reg_oras">Oraș *</label>
          <select id="reg_oras" required disabled>
            <option value="">Alege orașul</option>
          </select>

          <label for="phone">Telefon *</label>
          <div class="row">
            <input id="phone" placeholder="07..." class="w-auto" style="flex:1" inputmode="numeric"/>
            <button type="button" id="btnSendOtp" class="w-auto">Trimite cod</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="otp_code" placeholder="cod 6 cifre" maxlength="6" class="w-auto" style="flex:1" inputmode="numeric"/>
            <button type="button" id="btnVerifyOtp" class="w-auto">Verifică</button>
            <span id="phone_status" class="hint"></span>
          </div>

          <label for="email">Email *</label>
          <div class="row">
            <input id="email" type="email" placeholder="contact@..." style="flex:1"/>
          </div>
          <div id="email_status" class="hint"></div>

          <label for="description">Descriere</label>
          <textarea id="description" rows="4" placeholder="Ce servicii oferiți, zone acoperite..."></textarea>

          <div class="form-actions">
            <button type="button" class="btn-outline" onclick="history.back()">Înapoi</button>
            <button type="submit" id="btnSubmit" disabled>Trimite</button>
          </div>
          <div class="msg" id="msg" role="status" aria-live="polite"></div>
        </div>

        <!-- DREAPTA: subcategorii / copii -->
        <div class="card">
          <div class="toolbar">
            <div><strong>Subcategorii</strong> <span id="subcat-count-chip" class="meta-count"></span></div>
            <div class="row">
              <button type="button" class="btn-small" id="subcat-toggle">Restrânge</button>
              <button type="button" class="btn-small" id="subcat-reset">Reset</button>
            </div>
          </div>
          <div id="subcat-wrap">
            <div id="subcats"></div>
          </div>
        </div>

        <div class="card" id="child-wrap" hidden>
          <div class="child-title">
            <span>Sub-subcategorii (bifează minim 1)</span>
            <div class="row">
              <button type="button" class="btn-small" id="children-collapse-all">Restrânge toate</button>
              <button type="button" class="btn-small" id="children-expand-all">Extinde toate</button>
              <small id="min1-hint" class="hint-danger" style="display:none;margin-left:6px;">Selectează cel puțin una</small>
            </div>
          </div>
          <div id="children"></div>
        </div>
      </section>

      <!-- hidden pt backend -->
      <input type="hidden" id="subcat">
      <input type="hidden" id="subcat_name">
      <input type="hidden" id="subsub">
    </form>
  </main>

  <!-- Supabase (pt autentificare, neschimbat) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* =================== State & helpers =================== */
    const state = {
      phoneVerified: false,
      emailValid: false
    };

    const __sel = { bySub: new Map() };   // subId -> Set(childIds as strings)
    const __subMeta = new Map();          // subId -> {btn, name, badge}
    const __cacheChildren = new Map();    // subId -> children[]

    async function ajx(url){
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }
    function setChipColor(btn, on){ if(btn) btn.classList.toggle('blue', !!on); }
    function childGroupId(subId){ return 'cg_'+String(subId).replace(/[^a-z0-9_\-]/gi,'_'); }
    function ensureChildWrapVisible(){ document.getElementById('child-wrap').hidden=false; }
    function updateSidebarSelectedCount(){
      const n = Array.from(__sel.bySub.values()).filter(s=>s.size>0).length;
      const el = document.getElementById('subcat-count-chip');
      if(!el) return; el.textContent = n ? `(${n} selectate)` : '';
    }

    function syncHiddenFromState(){
      const ids=[], names=[];
      for (const [key,set] of __sel.bySub.entries()){
        if (!set.size) continue;
        const meta = __subMeta.get(key) || {};
        if (Number.isInteger(key)) ids.push(String(key));
        else names.push(meta.name || String(key));
      }
      document.getElementById('subcat').value = ids.join(',');
      document.getElementById('subcat_name').value = names.join(',');
      const firstKid = Array.from(__sel.bySub.values()).flatMap(s=>Array.from(s))[0];
      document.getElementById('subsub').value = firstKid ? String(firstKid) : '';
      updateSidebarSelectedCount();
      recalcSubmitState();
    }

    function renderChips(container, items){
      container.innerHTML=''; __subMeta.clear();
      items.forEach(it=>{
        const id = (it.id!=null) ? Number(it.id) : (it.subcat_id!=null ? Number(it.subcat_id) : String(it.name||it.subcat_name||''));
        const name = it.name ?? it.subcat_name ?? '';

        const btn = document.createElement('button');
        btn.type='button'; btn.className='chip'; btn.setAttribute('role','tab'); btn.setAttribute('aria-controls', childGroupId(id));

        const title = document.createElement('span'); title.className='title'; title.textContent=name;
        const badge = document.createElement('span'); badge.className='badge'; badge.textContent='0';
        btn.append(title,badge);

        __subMeta.set(id,{btn,name,badge});

        const has = (__sel.bySub.get(id)?.size||0)>0;
        setChipColor(btn, has);
        if (has) badge.textContent = String(__sel.bySub.get(id).size || 0);

        btn.addEventListener('click', ()=>toggleChildGroup(id));
        container.appendChild(btn);
      });
      document.getElementById('subcat-wrap').hidden = false;
      updateSidebarSelectedCount();
    }

    function updateChipBadge(subId){
      const meta = __subMeta.get(subId);
      if (!meta) return;
      const set = __sel.bySub.get(subId) || new Set();
      meta.badge.textContent = String(set.size || 0);
    }

    function resyncGroupCheckboxes(subId){
      const group = document.getElementById(childGroupId(subId));
      if (!group) return;
      const set = __sel.bySub.get(subId) || new Set();
      group.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.checked = set.has(String(cb.value));
        cb.closest('.child-item')?.classList.toggle('on', cb.checked);
      });
      const meta = __subMeta.get(subId)||{};
      setChipColor(meta.btn, set.size>0);
      updateChipBadge(subId);
      updateSidebarSelectedCount();
      recalcSubmitState();
    }

    async function toggleChildGroup(subId){
      ensureChildWrapVisible();
      const container = document.getElementById('children');
      const groupId = childGroupId(subId);
      let group = document.getElementById(groupId);
      const chip  = (__subMeta.get(subId)||{}).btn;

      const isOpen = !!group && !group.hidden;
      if (isOpen){ group.hidden = true; return; }

      if (!group){
        const kids = await loadChildren(subId);
        const meta = __subMeta.get(subId) || {};

        group = document.createElement('section');
        group.className = 'child-group';
        group.id = groupId;

        const title = document.createElement('div');
        title.className = 'child-title';
        title.appendChild(document.createTextNode(meta.name || ('Subcategorie ' + subId)));
        group.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'child-grid';
        const selectedSet = __sel.bySub.get(subId) || new Set();

        kids.forEach(kid=>{
          const safeKey = (kid.id != null) ? String(kid.id) : ('n_' + (kid.name || '').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,''));
          const inputId = `kid_${subId}_${safeKey}`;

          const lab = document.createElement('label'); lab.className='child-item'; lab.setAttribute('for', inputId);
          const cb  = document.createElement('input');
          cb.type='checkbox'; cb.id=inputId; cb.value=(kid.id != null) ? String(kid.id) : (kid.name || '');
          cb.checked = selectedSet.has(String(cb.value));
          if (cb.checked) lab.classList.add('on');

          cb.addEventListener('change', ()=>{
            let set = __sel.bySub.get(subId); if (!set){ set = new Set(); __sel.bySub.set(subId, set); }
            const val = String(cb.value);
            if (cb.checked) set.add(val); else set.delete(val);
            if (set.size===0) __sel.bySub.delete(subId);

            lab.classList.toggle('on', cb.checked);
            setChipColor(chip, set.size>0);
            updateChipBadge(subId);
            syncHiddenFromState();

            if (Array.from(__sel.bySub.values()).some(s => s.size > 0)){
              document.getElementById('min1-hint').style.display = 'none';
            }
          });

          lab.appendChild(cb);
          lab.appendChild(document.createTextNode(kid.name + (kid.count ? ` (${kid.count})` : '')));
          grid.appendChild(lab);
        });

        group.appendChild(grid);
        container.appendChild(group);
      }

      document.querySelectorAll('#children .child-group').forEach(g=>{ g.hidden = (g.id !== groupId); });
      group.hidden = false;
      resyncGroupCheckboxes(subId);
    }

    async function loadChildren(subId){
      if (__cacheChildren.has(subId)) return __cacheChildren.get(subId);
      const meta = __subMeta.get(subId) || {};
      const judet = document.getElementById('reg_judet')?.value || '';
      const oras  = document.getElementById('reg_oras')?.value || '';
      const subParam = Number.isInteger(subId) ? String(subId) : (meta.name || String(subId));

      const url = '/.netlify/functions/taxonomy?mode=children&subcat=' + encodeURIComponent(subParam)
                + (judet ? '&judet=' + encodeURIComponent(judet) : '')
                + (oras  ? '&oras='  + encodeURIComponent(oras)  : '');
      const { children=[] } = await ajx(url);
      __cacheChildren.set(subId, children);
      return children;
    }

    async function loadSubcatsForSignup(){
      const service = document.getElementById('service_name')?.value || '';
      const judet   = document.getElementById('reg_judet')?.value || '';
      const oras    = document.getElementById('reg_oras')?.value || '';
      const wrap    = document.getElementById('subcat-wrap');
      const cont    = document.getElementById('subcats');
      const childW  = document.getElementById('child-wrap');
      const childC  = document.getElementById('children');

      document.getElementById('subcat').value='';
      document.getElementById('subcat_name').value='';
      document.getElementById('subsub').value='';
      __sel.bySub.clear(); __subMeta.clear(); __cacheChildren.clear();
      childW.hidden=true; childC.innerHTML='';
      updateSidebarSelectedCount();
      recalcSubmitState();

      if (!service){ wrap.hidden=true; cont.innerHTML=''; return; }

      const url = '/.netlify/functions/taxonomy?mode=subcategories'
                + '&service=' + encodeURIComponent(service)
                + (judet ? '&judet=' + encodeURIComponent(judet) : '')
                + (oras  ? '&oras='  + encodeURIComponent(oras)  : '');

      try{
        const { subcategories=[] } = await ajx(url);
        if (!subcategories.length){ wrap.hidden=true; cont.innerHTML=''; return; }
        renderChips(cont, subcategories);
        wrap.hidden = false;
      }catch(e){ console.error(e); wrap.hidden=true; }
    }

    /* =================== OTP SMS (Twilio via Netlify Functions) =================== */
    const phoneEl = document.getElementById('phone');
    const otpEl = document.getElementById('otp_code');
    const phoneStatus = document.getElementById('phone_status');

    async function otpStart(){
      const to = phoneEl.value.trim();
      if (!to) return;
      phoneStatus.className='hint';
      phoneStatus.textContent='Trimit cod...';
      try{
        const r = await fetch('/.netlify/functions/otp_start', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ channel:'sms', to })
        });
        const txt = await r.text();
        let data; try{ data = JSON.parse(txt); } catch{ data = { error: txt }; }
        if (!r.ok || !data.ok){
          phoneStatus.className='hint hint-danger';
          phoneStatus.textContent = data.error || 'Nu am putut trimite codul.';
          return;
        }
        phoneStatus.className='hint';
        phoneStatus.textContent='Cod trimis. Verifică SMS-ul.';
      }catch(e){
        phoneStatus.className='hint hint-danger';
        phoneStatus.textContent='Eroare rețea.';
      }
    }

    async function otpVerify(){
      const to = phoneEl.value.trim();
      const code = otpEl.value.trim();
      if (!to || !code) return;
      phoneStatus.className='hint';
      phoneStatus.textContent='Verific...';
      try{
        const r = await fetch('/.netlify/functions/otp_verify', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ channel:'sms', to, code })
        });
        const txt = await r.text();
        let data; try{ data = JSON.parse(txt); } catch{ data = { error: txt }; }
        if (!r.ok || !data.ok || (data.status && data.status!=='approved')){
          state.phoneVerified = false;
          phoneStatus.className='hint hint-danger';
          phoneStatus.textContent = data.error || 'Cod invalid sau expirat.';
          recalcSubmitState();
          return;
        }
        state.phoneVerified = true;
        phoneStatus.className='hint hint-ok';
        phoneStatus.textContent='Verificat';
        recalcSubmitState();
      }catch(e){
        state.phoneVerified = false;
        phoneStatus.className='hint hint-danger';
        phoneStatus.textContent='Eroare verificare.';
        recalcSubmitState();
      }
    }

    document.getElementById('btnSendOtp').addEventListener('click', otpStart);
    document.getElementById('btnVerifyOtp').addEventListener('click', otpVerify);

    /* =================== Email: doar validare =================== */
    const emailEl = document.getElementById('email');
    const emailStatus = document.getElementById('email_status');
    function emailIsValid(v){
      // simplu dar robust pentru formă
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v);
    }
    function validateEmail(){
      const v = emailEl.value.trim();
      if (!v){ state.emailValid=false; emailStatus.textContent=''; recalcSubmitState(); return; }
      if (emailIsValid(v)){ state.emailValid=true; emailStatus.className='hint hint-ok'; emailStatus.textContent='Email valid'; }
      else { state.emailValid=false; emailStatus.className='hint hint-danger'; emailStatus.textContent='Email invalid'; }
      recalcSubmitState();
    }
    emailEl.addEventListener('input', validateEmail);

    /* =================== Submit button gating =================== */
    function hasAtLeastOneSubcat(){ return Array.from(__sel.bySub.values()).length>0; }
    function hasAtLeastOneChild(){ return Array.from(__sel.bySub.values()).some(s=>s.size>0); }

    function recalcSubmitState(){
      const company = document.getElementById('company_name').value.trim()!==''; 
      const service = document.getElementById('service_name').value.trim()!=='';
      const judet   = document.getElementById('reg_judet').value.trim()!=='';
      const oras    = document.getElementById('reg_oras').value.trim()!=='';
      const phoneOk = state.phoneVerified && (phoneEl.value.trim()!=='');
      const emailOk = state.emailValid;

      const structuralOk = company && service && judet && oras && hasAtLeastOneSubcat() && hasAtLeastOneChild();
      const finalOk = structuralOk && phoneOk && emailOk;

      const btn = document.getElementById('btnSubmit');
      btn.disabled = !finalOk;
    }

    ['company_name','service_name','reg_judet','reg_oras'].forEach(id=>{
      const el=document.getElementById(id);
      el.addEventListener('input', recalcSubmitState);
      el.addEventListener('change', recalcSubmitState);
    });
    phoneEl.addEventListener('input', ()=>{ state.phoneVerified=false; phoneStatus.textContent=''; recalcSubmitState(); });

    /* =================== Bootstrap lists (services, judete, orase) =================== */
    function fillSelect(sel, arr, firstLabel) {
      sel.innerHTML = '';
      const first = document.createElement('option');
      first.value = ''; first.textContent = firstLabel; sel.appendChild(first);
      (arr||[]).forEach(v=>{
        const name  = typeof v==='string' ? v : (v.name||v.label||v.text||'');
        const value = typeof v==='string' ? v : (v.value||v.name||v.id||'');
        if (!name) return;
        const o=document.createElement('option'); o.value=value; o.textContent=name; sel.appendChild(o);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // lists
      try {
        const r = await fetch('/.netlify/functions/lists?mode=signup', { cache:'no-store' });
        const { services=[], judete=[] } = await r.json();

        const selServ = document.getElementById('service_name');
        const selJ = document.getElementById('reg_judet');
        const selO = document.getElementById('reg_oras');

        fillSelect(selServ, services, 'Alege serviciul');
        fillSelect(selJ, judete,  'Alege județul');
        fillSelect(selO, [],      'Alege orașul'); selO.disabled=true;

        selJ.addEventListener('change', async (ev)=>{
          const judet=ev.target.value; fillSelect(selO,[], 'Alege orașul'); selO.disabled=true;
          if (!judet) { recalcSubmitState(); return; }
          const rr = await fetch('/.netlify/functions/lists?mode=signup&judet='+encodeURIComponent(judet), {cache:'no-store'});
          const { orase=[] } = await rr.json();
          fillSelect(selO, orase, 'Alege orașul'); selO.disabled=false;
          if (selServ.value) loadSubcatsForSignup();
          recalcSubmitState();
        });
        selO.addEventListener('change', ()=>{ if (selServ.value) loadSubcatsForSignup(); recalcSubmitState(); });
        selServ.addEventListener('change', ()=>{ loadSubcatsForSignup(); recalcSubmitState(); });

        if (!selServ.value && services.length){ selServ.value = services[0]; loadSubcatsForSignup(); }
      } catch(e){ console.error(e); }

      validateEmail(); // init
      recalcSubmitState();
    });

    /* =================== Submit handler (neschimbat pe backend) =================== */
    (async () => {
      const envRes = await fetch('/.netlify/functions/spa_env', { cache:'no-store' });
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = await envRes.json();
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      document.getElementById('f').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        // safety re-check
        recalcSubmitState();
        if (document.getElementById('btnSubmit').disabled) return;

        const form=ev.target, btn=document.getElementById('btnSubmit');
        const originalLabel=btn.textContent;
        btn.disabled=true; btn.setAttribute('aria-busy','true'); btn.textContent='Se trimite...';
        const msg=document.getElementById('msg'); msg.className='msg'; msg.textContent='Trimit...';

        const { data:{session} } = await supa.auth.getSession();
        if (!session?.access_token){
          msg.className='msg hint-danger'; msg.textContent='Trebuie să fii autentificat (butonul „Autentificare”).';
          btn.disabled=false; btn.removeAttribute('aria-busy'); btn.textContent=originalLabel; return;
        }

        const selectedChildIds = Array.from(__sel.bySub.values()).flatMap(s => Array.from(s)).map(v => Number(v)).filter(n => Number.isFinite(n));

        const payload = {
          company_name: document.getElementById('company_name').value.trim(),
          service_name: document.getElementById('service_name').value,
          judet:        document.getElementById('reg_judet').value,
          oras:         document.getElementById('reg_oras').value,
          phone:        document.getElementById('phone').value,
          email:        document.getElementById('email').value,
          description:  document.getElementById('description').value,
          subcat:       document.getElementById('subcat').value || null,
          subcat_name:  document.getElementById('subcat_name').value || null,
          subsub:       document.getElementById('subsub').value || null,
          subsubs:      selectedChildIds
        };

        try{
          const r = await fetch('/.netlify/functions/register_provider', {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':'Bearer '+session.access_token},
            body:JSON.stringify(payload)
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.error || 'Eroare necunoscută');
          msg.className='msg hint-ok'; msg.textContent='Înscriere reușită! Mulțumim.';
          form.reset(); document.getElementById('reg_oras').disabled=true;
          document.getElementById('child-wrap').hidden=true;
          document.getElementById('subcat-wrap').hidden=true;
          __sel.bySub.clear(); __subMeta.clear(); __cacheChildren.clear();
          state.phoneVerified=false; state.emailValid=false; document.getElementById('phone_status').textContent=''; document.getElementById('email_status').textContent='';
        }catch(e){
          msg.className='msg hint-danger'; msg.textContent='Eroare: '+e.message;
        }finally{
          btn.disabled=false; btn.removeAttribute('aria-busy'); btn.textContent=originalLabel;
          recalcSubmitState();
        }
      });
    })();

    /* UI buttons */
    document.getElementById('subcat-reset').addEventListener('click', ()=>{
      document.getElementById('subcat').value='';
      document.getElementById('subcat_name').value='';
      document.getElementById('subsub').value='';
      __sel.bySub.clear();
      for (const {btn,badge} of __subMeta.values()){ setChipColor(btn,false); if (badge) badge.textContent='0'; }
      document.getElementById('children').innerHTML='';
      document.getElementById('child-wrap').hidden=true;
      updateSidebarSelectedCount();
      recalcSubmitState();
    });
    document.getElementById('children-collapse-all').addEventListener('click', ()=>{ document.querySelectorAll('#children .child-group').forEach(g=> g.hidden = true); });
    document.getElementById('children-expand-all').addEventListener('click', ()=>{ document.querySelectorAll('#children .child-group').forEach(g=> g.hidden = false); });
    document.getElementById('subcat-toggle').addEventListener('click', (e)=>{
      const wrap = document.getElementById('subcat-wrap');
      const isHidden = wrap.style.display==='none';
      wrap.style.display = isHidden ? '' : 'none';
      e.target.textContent = isHidden ? 'Restrânge' : 'Extinde';
    });

    // Validare "minim 1 copil" dacă există cel puțin o subcategorie – guard la submit
    document.getElementById('f').addEventListener('submit',(ev)=>{
      const hasAnySub = __sel.bySub.size>0;
      const hasAnyKid = Array.from(__sel.bySub.values()).some(s=>s.size>0);
      if (hasAnySub && !hasAnyKid){
        ev.preventDefault();
        const hint = document.getElementById('min1-hint');
        hint.style.display='inline';
        document.getElementById('child-wrap').scrollIntoView({behavior:'smooth', block:'center'});
      }
    }, true);
  </script>
</body>
</html>
