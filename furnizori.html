<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Furnizori – VreauAjutor.ro</title>
<link rel="stylesheet" href="style.css">
<style>
  :root { --leftW: 25%; --gpad: 12px; }
  .page{display:flex;flex-direction:column;min-height:100vh;}
  .hero-search-band{flex:0 0 auto;} /* ai deja stilurile */

  .content{flex:1 1 auto;display:flex;gap:12px;max-width:1200px;margin:12px auto;padding:0 12px;height:calc(100vh - 160px);} /* 160px ~ header+hero approx */
  .left{flex:0 0 var(--leftW);background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;display:flex;flex-direction:column;min-width:240px}
  .left.min{--leftW: 12%;}
  .step{display:none} .step.active{display:block}
  .left .row{margin-bottom:8px}
  .left .actions{margin-top:auto;display:flex;gap:8px}
  .left .toggle{margin-top:8px}

  .right{flex:1 1 auto;display:flex;flex-direction:column;min-width:0;}
  .right .toolbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}
  .grid{flex:1 1 auto;display:grid;gap:12px;grid-template-columns:repeat(4,1fr); align-content:start;}
  .card{background:#fff;border:1px solid #eee;border-radius:14px;overflow:hidden;position:relative}
  .card .pic{height:120px;background:#f3f6fb}
  .card .body{padding:10px}
  .card .meta{font-size:12px;color:#666}
  .dot{position:absolute;right:8px;top:8px;width:10px;height:10px;border-radius:50%;background:#2ecc71;box-shadow:0 0 0 2px rgba(255,255,255,.8);}
  .card:hover .reveal{transform:translateY(0)}
  .reveal{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);color:#fff;padding:8px;transform:translateY(100%);transition:transform .2s}

  .pager{display:flex;justify-content:center;gap:8px;margin-top:8px}
  .btn{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:#004080;color:#fff;border-color:#004080}
</style>
</head>
<body class="page">

  <!-- header + hero la fel ca în index -->
  <section class="hero-search-band">
    <form class="hero-search" onsubmit="searchSubmit();return false;">
      <input id="heroQ" type="search" placeholder="ex: curățenie Cluj-Napoca">
      <button type="submit">Caută</button>
    </form>
  </section>

  <main class="content">
    <!-- STÂNGA 25% -->
    <aside id="left" class="left">
      <strong>Pasul 1</strong>
      <div id="step1" class="step active">
        <div class="row">
          <label>Județ</label>
          <select id="fil_judet"><option value="">Alege</option></select>
        </div>
        <div class="row">
          <label>Oraș</label>
          <select id="fil_oras" disabled><option value="">Alege</option></select>
        </div>
        <div class="row">
          <label>Categorie</label>
          <select id="fil_service"><option value="">Alege</option></select>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="next()">Următorul</button>
        </div>
      </div>

      <div id="step2" class="step">
        <strong>Subcategorii</strong>
        <div id="subchips" class="row" style="display:flex;gap:6px;flex-wrap:wrap"></div>
        <div class="actions">
          <button class="btn" onclick="prev()">Înapoi</button>
          <button class="btn primary" onclick="apply()">Aplică</button>
        </div>
      </div>

      <button class="btn toggle" onclick="toggleLeft()">Minimizează</button>
    </aside>

    <!-- DREAPTA 75% -->
    <section class="right">
      <div class="toolbar">
        <button class="btn" onclick="location.href='cautare-avansata.html'">Căutare avansată</button>
        <select id="sort" class="btn" onchange="reload()">
          <option value="new">Cele mai noi</option>
          <option value="old">Cele mai vechi</option>
          <option value="active">Cele mai active</option>
        </select>
      </div>

      <div id="grid" class="grid" aria-live="polite"></div>

      <div class="pager">
        <button class="btn" onclick="page(-1)">«</button>
        <span id="pageInfo"></span>
        <button class="btn" onclick="page(1)">»</button>
      </div>
    </section>
  </main>

  <script>
    let S = { services:[], subs:[] };
    let state = { judet:'', oras:'', service:'', subcat:'', page:1, per_page:12 };

    function toggleLeft(){
      const left = document.getElementById('left');
      left.classList.toggle('min');
      // 12 carduri normal, 15 când e min
      state.per_page = left.classList.contains('min') ? 15 : 12;
      reload();
    }

    function next(){
      if (!state.service){ alert('Alege întâi o categorie'); return; }
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
      renderSubs();
    }
    function prev(){
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step1').classList.add('active');
    }
   function apply(){
  state.page = 1;   // ← revino pe pagina 1
  reload();
}

    async function boot(){
      // liste
      const lr = await fetch('/.netlify/functions/lists'); const L = await lr.json();
      fillSel(document.getElementById('fil_service'), L.services);
      fillSel(document.getElementById('fil_judet'), L.judete);

      // pentru subcategorii

      // events
      document.getElementById('fil_judet').onchange = async (e)=>{
  state.judet = e.target.value;
  state.oras  = '';
  state.page  = 1;                 // ← revino pe pagina 1
  await reloadOrase();
  // dacă e deschis pasul 2, reîncarcă subcategoriile pentru noul context
  if (document.getElementById('step2').classList.contains('active')) renderSubs();
};

document.getElementById('fil_oras').onchange = (e)=>{
  state.oras = e.target.value;
  state.page = 1;                  // ← revino pe pagina 1
  if (document.getElementById('step2').classList.contains('active')) renderSubs();
};

document.getElementById('fil_service').onchange = (e)=>{
  state.service = e.target.value;
  state.subcat  = '';              // ← reset subcategorie
  state.page    = 1;
  if (document.getElementById('step2').classList.contains('active')) renderSubs();
};

      // query inițial din URL
      const p = new URLSearchParams(location.search);
      state.judet = p.get('judet') || '';
      state.oras  = p.get('oras')  || '';
      state.service = p.get('service') || '';
      state.subcat  = p.get('subcat')  || '';
      document.getElementById('fil_judet').value = state.judet;
      await reloadOrase(true);
      document.getElementById('fil_service').value = state.service;

      // per_page în funcție de stânga
      state.per_page = document.getElementById('left').classList.contains('min') ? 15 : 12;

      reload();
    }
    function fillSel(sel, arr){
      sel.innerHTML = '<option value="">Alege</option>';
      (arr||[]).forEach(v=>{
        const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
      });
    }
    async function reloadOrase(keep=false){
      const sel = document.getElementById('fil_oras');
      sel.disabled = true; fillSel(sel, []);
      if (!state.judet) return;
      const r = await fetch('/.netlify/functions/lists?judet='+encodeURIComponent(state.judet));
      const { orase=[] } = await r.json();
      fillSel(sel, orase);
      sel.disabled = false;
      if (keep && state.oras) sel.value = state.oras;
    }

    async function renderSubs(){
  const box = document.getElementById('subchips'); 
  box.innerHTML = '';
  if (!state.service) return;

  const u = '/.netlify/functions/taxonomy?mode=subcategories'
          + '&service=' + encodeURIComponent(state.service)
          + (state.judet ? '&judet=' + encodeURIComponent(state.judet) : '')
          + (state.oras  ? '&oras='  + encodeURIComponent(state.oras)  : '');

  try{
    const { subcategories = [] } = await (await fetch(u, {cache:'no-store'})).json();
    subcategories.forEach(sc=>{
      const b = document.createElement('button');
      b.className = 'btn';
      b.textContent = sc.name + (sc.count ? ` (${sc.count})` : '');
      if (String(state.subcat) === String(sc.id)) b.classList.add('primary');
      b.onclick = ()=>{ state.subcat = String(sc.id); renderSubs(); };
      box.appendChild(b);
    });
  }catch(e){
    console.error(e);
    box.innerHTML = '<span style="opacity:.7">Nu am putut încărca subcategoriile.</span>';
  }
}


    async function reload(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '<div class="card" style="grid-column:1/-1;padding:12px;text-align:center">Se încarcă…</div>';

  const q = new URLSearchParams();
  if (state.judet)   q.set('judet', state.judet);
  if (state.oras)    q.set('oras', state.oras);
  if (state.service) q.set('service', state.service);
  if (state.subcat)  q.set('subcat', state.subcat);
  q.set('sort', document.getElementById('sort').value);
  q.set('page', String(state.page));
  q.set('per_page', String(state.per_page));

  // păstrează URL-ul la zi
  const qs = q.toString();
history.replaceState(null, '', qs ? ('?' + qs) : location.pathname);


  try{
    const url = '/.netlify/functions/providers?' + q.toString();
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error(await r.text());
    const { items = [], total = 0 } = await r.json();

    grid.innerHTML = '';
    if (!items.length){
      grid.innerHTML = '<div class="card" style="grid-column:1/-1;padding:12px;text-align:center">Nu am găsit furnizori pentru filtrele alese.</div>';
    } else {
      items.forEach(p=>{
        const img = p.photo_url || p.logo || 'imagini-chatgpt/no-photo.png';
        const a = document.createElement('article'); 
        a.className='card';
        a.innerHTML = `
          <div class="pic" style="background:url('${img}') center/cover no-repeat"></div>
          <div class="body">
            <div style="display:flex;align-items:center;gap:6px">
              <h3 style="margin:.25rem 0; font-size:16px">${p.company_name || p.name || 'Furnizor'}</h3>
            </div>
            <div class="meta">${(p.judet || '') + (p.oras ? ', ' + p.oras : '')} · ${(p.service_name || state.service || '')}</div>
          </div>
          <div class="reveal">Vezi pagina furnizorului →</div>
        `;
        if (p.is_online) {
          const d = document.createElement('div'); d.className='dot'; a.appendChild(d);
        }
        a.onclick = ()=> location.href = '/p.html?slug=' + encodeURIComponent(slugify(p.company_name || p.name, p.oras || p.judet));
        grid.appendChild(a);
      });
    }

    state.total = total;
    updatePager();
  }catch(e){
    console.error(e);
    grid.innerHTML = '<div class="card" style="grid-column:1/-1;padding:12px;text-align:center;color:#b00020">Eroare la încărcare.</div>';
    document.getElementById('pageInfo').textContent = '';
  }
}
function updatePager(){
  const maxPage = Math.max(1, Math.ceil((state.total || 0) / state.per_page));
  document.getElementById('pageInfo').textContent = `Pagina ${state.page} / ${maxPage}`;
  const [prevBtn, nextBtn] = document.querySelectorAll('.pager .btn'); // doar 2 butoane
  if (prevBtn) prevBtn.disabled = state.page <= 1;
  if (nextBtn) nextBtn.disabled = state.page >= maxPage;
}



    function page(d){
      const info = document.getElementById('pageInfo').textContent;
      const m = /Pagina (\d+) \/ (\d+)/.exec(info);
      const cur = m ? parseInt(m[1],10) : 1;
      const max = m ? parseInt(m[2],10) : 1;
      const nxt = Math.min(max, Math.max(1, cur + d));
      if (nxt !== cur){ state.page = nxt; reload(); }
    }

    function normalizeRO(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // scoate diacritice
    .toLowerCase();
}
function slugify(name, loc){
  const n = normalizeRO(name).replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');
  const l = normalizeRO(loc||'').replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');
  return l ? `${n}-${l}` : n;
}


    async function searchSubmit(){
  const q = (document.getElementById('heroQ').value || '').trim();
  if(!q) return;

  try{
    const r = await fetch('/.netlify/functions/lists', { cache:'no-store' });
    const { services = [], judete = [] } = await r.json();
    const nQ = normalizeRO(q);
    const svc = services.find(s => nQ.includes(normalizeRO(s)));
    const jud = judete.find(j => nQ.includes(normalizeRO(j)));

    if (svc) { state.service = svc; document.getElementById('fil_service').value = svc; }
    if (jud) {
      state.judet = jud; document.getElementById('fil_judet').value = jud;
      await reloadOrase();
    }
    state.page = 1;
    reload();
  }catch(e){
    state.service = q; // fallback: tratăm textul ca numele serviciului
    state.page = 1;
    reload();
  }
}
boot();
  </script>
</body>
</html>
