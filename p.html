<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Furnizor - VreauAjutor.ro</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .wrap { max-width:1100px; margin:16px auto; padding:0 12px }
    .hero { display:flex; gap:16px; align-items:center; background:#fff; border:1px solid #eee; border-radius:12px; padding:12px }
    .cov { width:140px; height:140px; background:#f2f4f8; border-radius:12px; flex:0 0 140px; object-fit:cover }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; margin-top:12px }
    .prod { background:#fff; border:1px solid #eee; border-radius:12px; padding:10px }
    .msgbox { margin-top:12px; display:flex; gap:8px }
    .btn { padding:8px 12px; border:1px solid #ddd; border-radius:10px; background:#004080; color:#fff; cursor:pointer }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="hero">
      <img id="cover" class="cov" alt="Cover"/>
      <div>
        <h1 id="title"></h1>
        <div id="meta" style="color:#555"></div>
        <p id="desc"></p>
        <div class="msgbox">
          <input id="msg" placeholder="Scrie un mesaj furnizorului..." style="flex:1;padding:8px;border:1px solid #ccc;border-radius:8px">
          <button class="btn" onclick="send()">Trimite</button>
        </div>
      </div>
    </div>

    <h3>Servicii / produse</h3>
    <div id="prods" class="grid"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let provider = null;

    async function boot() {
      const p = new URLSearchParams(location.search);
      const slug = p.get('slug');
      if (!slug) return;

      try {
        const r = await fetch('/.netlify/functions/provider_page?slug=' + encodeURIComponent(slug));
        if (!r.ok) throw new Error("Eroare " + r.status);
        const json = await r.json();

        provider = json.provider || {};
        const page = json.page || {};
        const prods = json.products || [];

        document.getElementById('title').textContent = provider.company_name || "Furnizor";
        document.getElementById('meta').textContent =
          `${provider.judet || ''}${provider.oras ? ', ' + provider.oras : ''} Â· ${provider.service_name || ''}`;
        document.getElementById('desc').textContent = page.long_description || provider.description || '';
        if (page.cover_url) {
          document.getElementById('cover').src = page.cover_url;
        }

        document.getElementById('prods').innerHTML = prods.map(pr => `
          <article class="prod">
            ${pr.image_url ? `<img src="${pr.image_url}" alt="${pr.name}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:6px"/>` 
                           : `<div style="height:120px;background:#f7f9fc;border-radius:8px;margin-bottom:6px"></div>`}
            <strong>${pr.name}</strong><br>
            <small>${pr.description || ''}</small><br>
            <b>${pr.price || '-'} ${pr.currency || ''}</b>
          </article>
        `).join('');
      } catch (e) {
        console.error('Eroare boot:', e);
      }
    }

    async function send() {
      const body = document.getElementById('msg').value.trim();
      if (!body) return;

      try {
        const env = await fetch('/.netlify/functions/spa_env',{cache:'no-store'}).then(r=>r.json());
        const supa = window.supabase.createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY);
        const { data:{ session } } = await supa.auth.getSession();

        if (!session?.access_token) {
          window.openLogin?.(); // deschide modalul global
          return;
        }

        const r = await fetch('/.netlify/functions/messages', {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Authorization':'Bearer '+session.access_token
          },
          body: JSON.stringify({ chat_id: provider.id, text: body })
        });

        if (r.ok) {
          document.getElementById('msg').value = '';
          alert('Mesaj trimis!');
        } else {
          const err = await r.json().catch(()=>({}));
          alert('Eroare la trimitere: ' + (err.error || r.status));
        }
      } catch (e) {
        console.error('Send error:', e);
        alert('Eroare la trimitere.');
      }
    }

    boot();
  </script>
</body>
</html>