<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VreauAjutor.ro</title>
  <meta name="description" content="Găsește rapid furnizori locali pentru curățenie, instalatori, electricieni și multe altele. VreauAjutor.ro – servicii în toată România.">

  <!-- (opțional, mic boost LCP) -->
  <link rel="preload" as="image" href="imagini-chatgpt/curatenie.png">

  <!-- Fonts (preconnect + un singur stylesheet cu greutăți) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- CSS global + auth -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="./assets/css/auth.css" />

  <!-- AOS (animații la scroll – dacă vrei) -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => { if (window.AOS) AOS.init(); });
  </script>

  <!-- Supabase lib -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Loader ENV + client Supabase (sigur) -->
  <script>
    window.supa = null;
    window.supabaseReady = (async function loadEnvAndInit() {
      try {
        const res = await fetch('/.netlify/functions/spa_env', { cache: 'no-store' });
        if (!res.ok) {
          console.error('ENV endpoint failed', res.status);
          return false;
        }
        const env = await res.json().catch(() => ({}));
        if (!env.SUPABASE_URL || !env.SUPABASE_ANON_KEY) {
          console.error('ENV invalid', env);
          return false;
        }
        window.supa = supabase.createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY);
        return true;
      } catch (e) {
        console.error('ENV load failed', e);
        return false;
      }
    })();
  </script>
</head>

<body>
  <!-- MODAL autentificare/înregistrare -->
  <div id="authModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="modal-content">
      <h2 id="authTitle" class="sr-only">Autentificare sau înregistrare</h2>
      <button type="button" class="close" aria-label="Închide modalul" onclick="inchideModal()">
        <span aria-hidden="true">×</span>
      </button>

      <!-- Tab-urile Autentificare/Înregistrare -->
      <div class="tab-buttons" role="tablist" aria-label="Formular autentificare">
        <button type="button" id="tab-login" role="tab" aria-controls="loginForm" aria-selected="true" class="active" onclick="schimbaTab('login')">Autentificare</button>
        <button type="button" id="tab-register" role="tab" aria-controls="registerForm" aria-selected="false" onclick="schimbaTab('register')">Înregistrare</button>
      </div>

      <!-- Panou LOGIN -->
      <div id="loginForm" class="tab-content" role="tabpanel" aria-labelledby="tab-login" aria-hidden="false">
        <label class="sr-only" for="login_email">Email</label>
        <input type="email" id="login_email" name="email" placeholder="Email" autocomplete="username" required>
        <label class="sr-only" for="login_password">Parolă</label>
        <input type="password" id="login_password" name="password" placeholder="Parolă" autocomplete="current-password" required>
        <button type="button" onclick="autentificare()">Autentificare</button>

        <div class="or">SAU</div>
        <!-- Social login rapid (redirect direct spre ofera-servicii după auth) -->
        <div class="row">
          <button id="loginGoogle" class="btn google-btn" type="button" aria-label="Continuă cu Google" style="flex:1">
            <span class="google-icon" aria-hidden="true">G</span><span>Google</span>
          </button>
          <button id="loginApple" class="btn" type="button" aria-label="Continuă cu Apple" style="flex:1">
             Apple
          </button>
        </div>
        <button id="loginFacebook" class="btn" type="button" aria-label="Continuă cu Facebook" style="margin-top:8px">
          f Facebook
        </button>
      </div>

      <!-- Panou REGISTER -->
      <div id="registerForm" class="tab-content" role="tabpanel" aria-labelledby="tab-register" aria-hidden="true" style="display:none;">
        <label class="sr-only" for="register_email">Email</label>
        <input type="email" id="register_email" placeholder="Email" autocomplete="email" required>
        <label class="sr-only" for="register_password">Parolă</label>
        <input type="password" id="register_password" placeholder="Parolă (minim 9 caractere)" autocomplete="new-password" required>

        <label class="agree" style="margin-top:6px">
          <input id="register_agree" type="checkbox" />
          <span>Sunt de acord cu <a href="/termeni.html" target="_blank" rel="noopener">Termenii și condițiile</a> și <a href="/confidentialitate.html" target="_blank" rel="noopener">Politica de confidențialitate</a>.</span>
        </label>

        <button type="button" onclick="inregistrare()">Creează un cont</button>

        <div class="or">SAU</div>
        <div class="row">
          <button id="registerGoogle" class="btn google-btn" type="button" aria-label="Continuă cu Google" style="flex:1">
            <span class="google-icon" aria-hidden="true">G</span><span>Google</span>
          </button>
          <button id="registerApple" class="btn" type="button" aria-label="Continuă cu Apple" style="flex:1">
             Apple
          </button>
        </div>
        <button id="registerFacebook" class="btn" type="button" aria-label="Continuă cu Facebook" style="margin-top:8px">
          f Facebook
        </button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <img src="imagini-chatgpt/logo.png" alt="Vreau Ajutor">
      <h1>VreauAjutor.ro</h1>
    </div>
    <nav>
      <a href="index.html">Acasă</a>
      <a href="furnizori.html">Furnizori</a>
      <!-- Linkul „Oferă servicii” este protejat: dacă nu ești autentificat -> deschide modalul -->
      <a href="ofera-servicii.html" class="cta-suppliers requires-auth" data-requires-auth="true">Oferă servicii</a>
      <a href="#">Contact</a>
    </nav>

    <div class="auth-buttons">
      <button id="btnLogin" onclick="openLogin()">Autentificare</button>
      <button id="btnRegister" onclick="openRegister()">Înregistrare</button>
      <!-- link informativ – îl păstrăm dar tot protejat -->
      <a href="ofera-servicii.html" class="link-suppliers requires-auth" data-requires-auth="true">Oferă servicii (pentru firme)</a>
    </div>
  </header>

  <!-- HERO SEARCH (bandă albastră deasupra sliderului) -->
  <section class="hero-search-band" role="search">
    <form class="hero-search" onsubmit="heroSearch(); return false;">
      <input id="heroQuery" type="search" placeholder="Ex: curățenie Cluj-Napoca"
             aria-label="Caută servicii sau oraș" enterkeyhint="search">
      <button type="submit">Caută</button>
    </form>
  </section>

  <!-- SLIDER + SELECTOR -->
  <section class="sectiune-slider-selector"
           data-aos="fade-up"
           data-aos-duration="600"
           data-aos-easing="ease-out-cubic">

    <div class="slider-modern">
      <div class="slider-container">
        <div class="slides" id="slides">
          <!-- Prima imagine: LCP mai rapid -->
          <img src="imagini-chatgpt/curatenie.png" alt="Curățenie"
               loading="eager" fetchpriority="high" decoding="async">
          <!-- Restul: lazy -->
          <img src="imagini-chatgpt/instal.png" alt="Instalator" loading="lazy" decoding="async">
          <img src="imagini-chatgpt/mecanic.png" alt="Mecanic" loading="lazy" decoding="async">
          <img src="imagini-chatgpt/transport.png" alt="Transport" loading="lazy" decoding="async">
          <img src="imagini-chatgpt/bone.png" alt="Bone" loading="lazy" decoding="async">
          <img src="imagini-chatgpt/electricieni.png" alt="Electricieni" loading="lazy" decoding="async">
        </div>
        <button class="prev" type="button" aria-label="Slide anterior" onclick="moveSlide(-1)">‹</button>
        <button class="next" type="button" aria-label="Slide următor"  onclick="moveSlide(1)">›</button>
      </div>
    </div>

    <div class="selector-zona">
      <h3>Selectează zona și serviciul:</h3>

      <label for="judet">Județ:</label>
      <select id="judet" aria-label="Județ">
        <option value="" selected>Alege județul</option>
      </select>

      <label for="oras">Oraș:</label>
      <select id="oras" aria-label="Oraș">
        <option value="" selected>Alege orașul</option>
      </select>

      <label for="serviciu">Serviciu:</label>
      <select id="serviciu" aria-label="Serviciu">
        <option value="" selected>Alege serviciul</option>
      </select>

      <button
        type="button"
        class="advanced-toggle"
        id="btnAdv"
        aria-expanded="false"
        aria-controls="advanced-panel"
        onclick="toggleAdvanced()">
        Căutare avansată
      </button>

      <div id="advanced-panel" class="advanced-panel" hidden>
        <label for="price_max">Preț maxim (lei)</label>
        <input type="number" id="price_max" min="0" step="1" inputmode="numeric" placeholder="ex: 300">

        <label for="rating_min">Rating minim</label>
        <select id="rating_min">
          <option value="">Indiferent</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
          <option value="4.5">4.5+</option>
        </select>

        <label class="chk">
          <input type="checkbox" id="available_today"> Disponibil azi
        </label>

        <label class="chk">
          <input type="checkbox" id="has_photos"> Numai cu fotografii
        </label>

        <!-- Subcategorii + copii (pentru căutare avansată) -->
        <div id="subcat-wrap" class="advanced-panel" style="margin-top:10px;" hidden>
          <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
            <strong>Subcategorii</strong>
            <button type="button" id="reset-subcat" class="advanced-toggle" style="width:auto;padding:4px 10px;">Reset</button>
          </div>
          <div id="subcats" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>

        <div id="child-wrap" class="advanced-panel" style="margin-top:10px;" hidden>
          <strong>Sub-subcategorii</strong>
          <div id="children" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>

        <input type="hidden" id="subcat">
        <input type="hidden" id="subsub">
      </div>

      <button type="button" onclick="gotoFurnizori()">Caută</button>
    </div>
  </section>

  <!-- SERVICII POPULARE -->
  <section class="servicii-populare"
           data-aos="fade-up"
           data-aos-delay="120"
           data-aos-duration="600">
    <h2>Servicii Populare</h2>
    <div class="servicii-container">
      <div class="serviciu-box">
        <img src="imagini-chatgpt/curatenie.png" alt="Curățenie" loading="lazy" decoding="async">
        <p>Curățenie locuințe, birouri, spații comerciale</p>
      </div>
      <div class="serviciu-box">
        <img src="imagini-chatgpt/instal.png" alt="Instalator" loading="lazy" decoding="async">
        <p>Reparații instalații sanitare, țevi, robineți</p>
      </div>
      <div class="serviciu-box">
        <img src="imagini-chatgpt/electricieni.png" alt="Electrician" loading="lazy" decoding="async">
        <p>Panouri, prize, iluminat, reparații electrice</p>
      </div>
      <div class="serviciu-box">
        <img src="imagini-chatgpt/bone.png" alt="Bone" loading="lazy" decoding="async">
        <p>Îngrijire copii, dus/adus, supraveghere</p>
      </div>
      <div class="serviciu-box">
        <img src="imagini-chatgpt/electrocasnice.png" alt="Electrocasnice" loading="lazy" decoding="async">
        <p>Reparații electrocasnice, frigidere, mașini de spălat</p>
      </div>
    </div>
  </section>

  <!-- CUM FUNCȚIONEAZĂ -->
  <section class="cum-functioneaza"
           data-aos="fade-up"
           data-aos-delay="200"
           data-aos-duration="600">
    <h2>Cum funcționează</h2>
    <ol>
      <li>Selectezi județul, orașul și serviciul</li>
      <li>Primești lista firmelor disponibile</li>
      <li>Plasezi comanda sau iei legătura direct</li>
    </ol>
  </section>

  <!-- FOOTER -->
  <footer>
    <p>&copy; 2025 VreauAjutor.ro – Toate drepturile rezervate.</p>
  </footer>

  <!-- AjutorBot – widget plutitor -->
  <div id="ajb-widget" class="minimized">
    <div class="ajb-header" role="button" tabindex="0"
         aria-controls="ajb-panel" aria-expanded="false"
         onclick="toggleAjb()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleAjb();}">
      <span>AjutorBot 🤖</span>
      <span style="margin-left:auto;opacity:.6;font-size:12px;">Click pentru a deschide</span>
    </div>

    <div class="ajb-body" id="ajb-panel">
      <div id="ajb-messages" aria-live="polite" aria-atomic="false"></div>
      <div class="ajb-input">
        <input id="ajb-input" type="text" placeholder="Scrie mesajul tău..." onkeydown="if(event.key==='Enter') ajbSend()" />
        <button onclick="ajbSend()">Trimite</button>
      </div>
    </div>
  </div>

  <!-- ================== JS APP ================== -->

  <!-- Slider + modal + accesibilitate + vechiul comportament -->
  <script src="script.js"></script>

  <!-- Helpers pentru AJAX simplu -->
  <script>
    async function ajx(url){
      const r = await fetch(url);
      if(!r.ok){
        const t = await r.text().catch(()=> '');
        throw new Error(`HTTP ${r.status} ${t}`);
      }
      return r.json().catch(()=> { throw new Error('Răspuns invalid (nu e JSON)'); });
    }
  </script>

  <!-- Selectoare dependente (judet/oras/serviciu) + căutare -->
  <script>
    const elJudet     = document.getElementById('judet');
    const elOras      = document.getElementById('oras');
    const elCategorie = document.getElementById('serviciu');

    function setOptions(selectEl, items, placeholder) {
      if (!selectEl) return;
      const opts = [`<option value="">${placeholder}</option>`]
        .concat((items || []).map(v => {
          const val = (v.value ?? v).toString();
          const lab = (v.label ?? v).toString();
          return `<option value="${val.replaceAll('"','&quot;')}">${lab}</option>`;
        }));
      selectEl.innerHTML = opts.join('');
    }

    async function loadJudete() {
      try {
        const { judete } = await ajx('/.netlify/functions/lists');
        setOptions(elJudet, (judete || []).map(j => ({ value: j, label: j })), 'Alege județul');
        setOptions(elOras, [], 'Alege orașul');
        setOptions(elCategorie, [], 'Alege serviciul');
      } catch (e) {
        console.error('loadJudete failed', e);
        setOptions(elJudet, [], 'Eroare la încărcarea județelor');
      }
    }

    async function loadOrase(judet) {
      try {
        if (!judet) { setOptions(elOras, [], 'Alege orașul'); setOptions(elCategorie, [], 'Alege serviciul'); return; }
        const { orase } = await ajx(`/.netlify/functions/lists?judet=${encodeURIComponent(judet)}`);
        setOptions(elOras, (orase || []).map(o => ({ value: o, label: o })), 'Alege orașul');
        setOptions(elCategorie, [], 'Alege serviciul');
      } catch (e) {
        console.error('loadOrase failed', e);
        setOptions(elOras, [], 'Eroare la încărcarea orașelor');
      }
    }

    async function loadCategorii(judet, oras) {
      try {
        if (!judet || !oras) { setOptions(elCategorie, [], 'Alege serviciul'); return; }
        const { names = [] } = await ajx(`/.netlify/functions/lists?judet=${encodeURIComponent(judet)}&oras=${encodeURIComponent(oras)}`);
        setOptions(elCategorie, (names || []).map(n => ({ value: n, label: n })), 'Alege serviciul');
      } catch (e) {
        console.error('loadCategorii failed', e);
        setOptions(elCategorie, [], 'Eroare la încărcarea serviciilor');
      }
    }

    elJudet?.addEventListener('change', (ev) => { loadOrase(ev.target.value || ''); });
    elOras ?.addEventListener('change', (ev) => { loadCategorii(elJudet?.value || '', ev.target.value || ''); });

    document.addEventListener('DOMContentLoaded', loadJudete);
  </script>

  <!-- Căutarea din banda albastră -->
  <script>
    function normalizeRO(s){
      return (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'');
    }
    async function heroSearch(){
      const q = (document.getElementById('heroQuery').value || '').trim();
      if(!q) return;
      try{
        const { judete = [] } = await ajx('/.netlify/functions/lists');
        const services = []; // nu filtrăm după listă globală
        const nQ = normalizeRO(q);
        const svc = services.find(s => nQ.includes(normalizeRO(s)));
        const jud = judete.find(j => nQ.includes(normalizeRO(j)));
        const params = new URLSearchParams();
        if (svc) params.set('service', svc);
        if (jud) params.set('judet', jud);
        if (!svc && !jud) params.set('service', q);
        location.href = 'furnizori.html' + (params.toString() ? '?' + params.toString() : '');
      }catch(e){
        location.href = 'furnizori.html?service=' + encodeURIComponent(q);
      }
    }
  </script>

  <!-- Subcategorii/copii pentru panoul avansat -->
  <script>
    function renderChips(container, items, onClick){
      container.innerHTML = '';
      (items || []).forEach(it => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = it.name + (it.count ? ` (${it.count})` : '');
        b.title = it.name;
        b.style.cssText = 'padding:6px 10px;border:1px solid #ccc;border-radius:999px;background:#fff;cursor:pointer;';
        b.addEventListener('click', () => onClick(it));
        container.appendChild(b);
      });
    }

    async function loadSubcatsForSelectedService() {
      const service = document.getElementById('serviciu')?.value || '';
      const judet   = document.getElementById('judet')?.value || '';
      const oras    = document.getElementById('oras')?.value || '';
      const wrap    = document.getElementById('subcat-wrap');
      const cont    = document.getElementById('subcats');
      const childW  = document.getElementById('child-wrap');
      const hidSub  = document.getElementById('subcat');
      const hidKid  = document.getElementById('subsub');

      hidSub.value = ''; hidKid.value = '';
      childW.hidden = true; document.getElementById('children').innerHTML = '';
      if (!service){ wrap.hidden = true; cont.innerHTML = ''; return; }

      const url = '/.netlify/functions/taxonomy?mode=subcategories'
                + '&service=' + encodeURIComponent(service)
                + (judet ? '&judet='+encodeURIComponent(judet) : '')
                + (oras  ? '&oras=' +encodeURIComponent(oras)  : '');
      try{
        const { subcategories = [] } = await ajx(url);
        if (!subcategories.length){ wrap.hidden = true; cont.innerHTML = ''; return; }
        wrap.hidden = false;
        renderChips(cont, subcategories, (item) => {
          hidSub.value = item.id || item.name;
          hidKid.value = '';
          loadChildrenForSubcat(item.id || item.name);
        });
      }catch(e){
        console.error(e);
        wrap.hidden = true;
      }
    }

    async function loadChildrenForSubcat(subcatId){
      const judet  = document.getElementById('judet')?.value || '';
      const oras   = document.getElementById('oras')?.value || '';
      const wrap   = document.getElementById('child-wrap');
      const cont   = document.getElementById('children');
      const hidKid = document.getElementById('subsub');

      const url = '/.netlify/functions/taxonomy?mode=children&subcat='+encodeURIComponent(subcatId)
                + (judet ? '&judet='+encodeURIComponent(judet) : '')
                + (oras  ? '&oras=' +encodeURIComponent(oras)  : '');
      try{
        const { children = [] } = await ajx(url);
        if (!children.length){ wrap.hidden = true; cont.innerHTML = ''; return; }
        wrap.hidden = false;
        renderChips(cont, children, (kid) => { hidKid.value = kid.id || kid.name; });
      }catch(e){
        console.error(e);
        wrap.hidden = true;
      }
    }

    const _oldToggleAdvanced = window.toggleAdvanced;
    window.toggleAdvanced = function(){
      if (typeof _oldToggleAdvanced === 'function') _oldToggleAdvanced();
      const panelEl = document.getElementById('advanced-panel');
      const panelNowOpen = panelEl && !panelEl.hasAttribute('hidden');
      if (panelNowOpen) loadSubcatsForSelectedService();
    };
    document.getElementById('serviciu')?.addEventListener('change', loadSubcatsForSelectedService);
    document.getElementById('reset-subcat')?.addEventListener('click', () => {
      document.getElementById('subcat').value = '';
      document.getElementById('subsub').value = '';
      document.getElementById('child-wrap').hidden = true;
      document.getElementById('children').innerHTML = '';
    });
  </script>

  <!-- Goto furnizori din selector -->
  <script>
    function gotoFurnizori() {
      const judet    = document.getElementById('judet')?.value || '';
      const oras     = document.getElementById('oras')?.value || '';
      const serviciu = document.getElementById('serviciu')?.value || '';
      const subcat   = document.getElementById('subcat')?.value || '';
      const subsub   = document.getElementById('subsub')?.value || '';

      const priceMax = document.getElementById('price_max')?.value?.trim() || '';
      const ratingMin= document.getElementById('rating_min')?.value || '';
      const today    = document.getElementById('available_today')?.checked || false;
      const photos   = document.getElementById('has_photos')?.checked || false;

      const params = new URLSearchParams();
      if (judet)    params.set('judet', judet);
      if (oras)     params.set('oras', oras);
      if (serviciu) params.set('service', serviciu);
      if (subcat)   params.set('subcat', subcat);
      if (subsub)   params.set('subsub', subsub);
      if (priceMax) params.set('pmax', priceMax);
      if (ratingMin)params.set('rmin', ratingMin);
      if (today)    params.set('today', '1');
      if (photos)   params.set('photos', '1');

      window.location.href = 'furnizori.html' + (params.toString() ? '?' + params.toString() : '');
    }
    ['price_max','rating_min','judet','oras','serviciu'].forEach(id=>{
      document.getElementById(id)?.addEventListener('keydown', e=>{
        if (e.key === 'Enter') { e.preventDefault(); gotoFurnizori(); }
      });
    });
  </script>

  <!-- ================== AUTH INIT + GATING „Oferă servicii” ================== -->
  <script>
    function rememberRedirect(to) {
      try { localStorage.setItem('__va_after_login_redirect', to); } catch {}
    }
    function consumeRedirect() {
      try {
        const to = localStorage.getItem('__va_after_login_redirect');
        if (to) { localStorage.removeItem('__va_after_login_redirect'); return to; }
      } catch {}
      return null;
    }

    (async () => {
      // Așteaptă inițializarea sigură
      const ok = await window.supabaseReady;
      if (!ok || !window.supa) {
        console.warn('Supabase nu este gata; gating by modal.');
      }

      // 1) Header: „Salut, email” + Ieșire
      try {
        if (window.supa) {
          const { data:{ user } } = await window.supa.auth.getUser();
          if (user) {
            const box = document.querySelector('.auth-buttons');
            if (box) {
              document.getElementById('btnLogin')?.remove();
              document.getElementById('btnRegister')?.remove();

              const hi = document.createElement('div');
              hi.style.fontSize = '13px'; hi.style.opacity = '.9';
              hi.textContent = `Salut, ${user.email}`;

              const out = document.createElement('button');
              out.textContent = 'Ieșire';
              out.style.padding = '6px 10px';
              out.onclick = async () => { await window.supa.auth.signOut(); location.reload(); };

              box.append(hi, out);
            }
          }
        }
      } catch(e){ console.warn(e); }

      // 2) Interceptează link-urile protejate (ofera-servicii)
      document.querySelectorAll('a.requires-auth,[data-requires-auth="true"]').forEach(a=>{
        a.addEventListener('click', async (ev)=>{
          const href = a.getAttribute('href') || '/ofera-servicii.html';
          try {
            const okReady = await window.supabaseReady;
            if (!okReady || !window.supa) {
              ev.preventDefault();
              rememberRedirect(href);
              openRegister();
              return;
            }
            const { data:{ session } } = await window.supa.auth.getSession();
            if (!session?.access_token) {
              ev.preventDefault();
              rememberRedirect(href);
              openRegister(); // sau openLogin()
            }
          } catch(e) {
            ev.preventDefault();
            rememberRedirect(href);
            openRegister();
          }
        });
      });

      // 3) Dacă venim dintr-un flux de login care a setat redirect-ul
      const pending = consumeRedirect();
      if (pending && window.supa) {
        try {
          const { data:{ session } } = await window.supa.auth.getSession();
          if (session?.access_token) location.replace(pending);
        } catch {}
      }
    })();
  </script>

  <!-- ================== Email/parolă + Social (cu redirect spre ofera-servicii) ================== -->
  <script>
    // Mesaj mic în modal
    function toastMsg(t, ok=false){
      try{
        const el = document.getElementById('authTitle');
        el.textContent = t;
        setTimeout(()=>{ el.textContent='Autentificare sau înregistrare'; }, 2000);
      }catch{}
    }
    const validPass = (p)=> /(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{9,}/.test(p||'');

    // Social OAuth: mereu cu redirect către ofera-servicii.html
    async function startOAuth(provider){
      const ok = await window.supabaseReady;
      if (!ok || !window.supa) { alert('Serviciul de autentificare nu este disponibil momentan.'); return; }
      try{
        rememberRedirect('/ofera-servicii.html');
        await window.supa.auth.signInWithOAuth({
          provider,
          options: { redirectTo: window.location.origin + '/auth-callback.html' }
        });
      }catch(e){ toastMsg(e.message || 'Nu am putut porni autentificarea.'); }
    }
    // Hook butoane social din ambele tab-uri
    document.getElementById('loginGoogle')   ?.addEventListener('click', ()=> startOAuth('google'));
    document.getElementById('loginApple')    ?.addEventListener('click', ()=> startOAuth('apple'));
    document.getElementById('loginFacebook') ?.addEventListener('click', ()=> startOAuth('facebook'));
    document.getElementById('registerGoogle')?.addEventListener('click', ()=> startOAuth('google'));
    document.getElementById('registerApple') ?.addEventListener('click', ()=> startOAuth('apple'));
    document.getElementById('registerFacebook')?.addEventListener('click', ()=> startOAuth('facebook'));

    // Înregistrare cu email/parolă -> după confirmarea emailului redirect spre ofera-servicii.html
    async function inregistrare(){
      const ok = await window.supabaseReady;
      if (!ok || !window.supa) { alert('Auth indisponibil'); return; }

      const email = document.getElementById('register_email')?.value?.trim();
      const pass  = document.getElementById('register_password')?.value||'';
      const okA   = document.getElementById('register_agree')?.checked;

      if (!email) return alert('Completează email-ul');
      if (!validPass(pass)) return alert('Parola nu respectă regulile (min 9 caractere, literă mare, literă mică, cifră).');
      if (!okA) return alert('Trebuie să accepți termenii.');

      rememberRedirect('/ofera-servicii.html');
      try{
        const { error } = await window.supa.auth.signUp({
          email, password: pass,
          options:{ emailRedirectTo: location.origin + '/auth-callback.html' }
        });
        if (error) throw error;
        alert('Ți-am trimis un email de confirmare. După confirmare te vom duce la Oferă servicii.');
        inchideModal();
      }catch(e){ alert('Eroare: ' + (e.message || 'nu s-a putut crea contul')); }
    }

    // Autentificare cu email/parolă -> redirect imediat către ofera-servicii.html
    async function autentificare(){
      const ok = await window.supabaseReady;
      if (!ok || !window.supa) { alert('Auth indisponibil'); return; }

      const email = document.getElementById('login_email')?.value?.trim();
      const pass  = document.getElementById('login_password')?.value||'';
      if (!email || !pass) return alert('Completează email + parolă');

      try{
        const { error } = await window.supa.auth.signInWithPassword({ email, password: pass });
        if (error) throw error;
        inchideModal();
        location.href = '/ofera-servicii.html';
      }catch(e){ alert('Eroare: ' + (e.message || 'nu te-am putut autentifica')); }
    }

    // expunem pe window pentru butoanele din HTML
    window.inregistrare = inregistrare;
    window.autentificare = autentificare;
  </script>

  <!-- AjutorBot – widget (apel API prin Netlify redirect) -->
  <script>
    const AJB_API = new URLSearchParams(location.search).get('api') || '/chat';

    function toggleAjb(){
      const w = document.getElementById('ajb-widget');
      const header = w.querySelector('.ajb-header');
      w.classList.toggle('minimized');
      const expanded = !w.classList.contains('minimized');
      header.setAttribute('aria-expanded', String(expanded));
      if (expanded) setTimeout(() => document.getElementById('ajb-input').focus(), 0);
    }
    window.toggleAjb = toggleAjb;

    function ajbAppend(sender, text){
      const box = document.getElementById('ajb-messages');
      const d = document.createElement('div');
      d.style.margin = '6px 0';
      d.innerHTML = '<strong>' + sender + ':</strong> ' + (text || '');
      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
    }

    async function ajbSend(){
      const inp = document.getElementById('ajb-input');
      const txt = (inp.value || '').trim();
      if(!txt) return;
      ajbAppend('Tu', txt);
      inp.value = '';
      try{
        const r = await fetch(AJB_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: txt })
        });
        if (!r.ok) throw new Error('Request failed: ' + r.status + ' ' + r.statusText);
        const data = await r.json().catch(()=> ({}));
        ajbAppend('AjutorBot', data.reply ?? 'Răspuns gol de la server.');
      }catch(e){
        console.error(e);
        ajbAppend('AjutorBot', 'Nu pot contacta serverul. Verifică dacă rulează backend-ul și cheile.');
      }
    }
    window.ajbSend = ajbSend;
  </script>
</body>
</html>