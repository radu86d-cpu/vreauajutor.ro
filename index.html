<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VreauAjutor.ro</title>
  <meta name="description" content="Găsește rapid furnizori locali pentru curățenie, instalatori, electricieni și multe altele. VreauAjutor.ro – servicii în toată România.">
<!-- (opțional, mic boost LCP) -->
<link rel="preload" as="image" href="imagini-chatgpt/curatenie.png">


  <!-- Fonts (preconnect + un singur stylesheet cu greutăți) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- CSS-ul tău -->
  <link rel="stylesheet" href="style.css" />

  <!-- AOS -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => AOS.init());
  </script>
</head>

<body>
  <!-- MODAL autentificare/înregistrare (mutat corect în <body>) -->
  <div id="authModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
  <div class="modal-content">
  <h2 id="authTitle" class="sr-only">Autentificare sau înregistrare</h2>

  <button type="button" class="close" aria-label="Închide modalul" onclick="inchideModal()">
    <span aria-hidden="true">×</span>
  </button>

  <!-- TAB-URI accesibile -->
  <div class="tab-buttons" role="tablist" aria-label="Formular autentificare">
    <button
      type="button"
      id="tab-login"
      role="tab"
      aria-controls="loginForm"
      aria-selected="true"
      class="active"
      onclick="schimbaTab('login')">
      Autentificare
    </button>

    <button
      type="button"
      id="tab-register"
      role="tab"
      aria-controls="registerForm"
      aria-selected="false"
      onclick="schimbaTab('register')">
      Înregistrare
    </button>
  </div>

  <!-- Panou LOGIN -->
  <div id="loginForm"
       class="tab-content"
       role="tabpanel"
       aria-labelledby="tab-login"
       aria-hidden="false">
    <input type="email" id="login_email" name="email" placeholder="Email"
           autocomplete="username" required>
    <input type="password" id="login_password" name="password" placeholder="Parolă"
           autocomplete="current-password" required>
    <button type="button" onclick="autentificare()">Autentificare</button>
  </div>

  <!-- Panou REGISTER -->
  <div id="registerForm"
       class="tab-content"
       role="tabpanel"
       aria-labelledby="tab-register"
       aria-hidden="true"
       style="display:none;">
    <input type="text" id="register_name" placeholder="Nume complet" autocomplete="name">
    <input type="email" id="register_email" placeholder="Email" autocomplete="email">
    <input type="password" id="register_password" placeholder="Parolă" autocomplete="new-password">
    <input type="text" id="register_location" placeholder="Localitate" autocomplete="address-level2">

    <button type="button" onclick="inregistrare()">Înregistrare</button>

    <button type="button" id="googleSignIn" class="google-btn" aria-label="Continuă cu Google">
      <span class="google-icon" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 48 48">
          <path fill="#EA4335" d="M24 9.5c3.88 0 7.36 1.34 10.1 3.97l7.57-7.57C36.84 1.96 30.79 0 24 0 14.62 0 6.45 4.98 2.24 12.27l8.96 6.96C13.44 14.08 18.32 9.5 24 9.5z"/>
          <path fill="#FBBC05" d="M46.5 24c0-1.62-.15-3.17-.44-4.65H24v9.08h12.7c-.55 2.95-2.2 5.45-4.7 7.13l7.2 5.59C43.83 37.4 46.5 31.22 46.5 24z"/>
          <path fill="#4285F4" d="M31.99 35.56C29.7 37.08 26.98 38 24 38c-6.06 0-11.2-3.85-13.1-9.22l-8.96 6.96C5.95 43.02 14.12 48 24 48c6.57 0 12.1-2.17 16.13-5.88l-8.14-6.56z"/>
          <path fill="#34A853" d="M10.9 28.78C10.41 27.26 10.14 25.66 10.14 24s.27-3.26.76-4.78l-8.96-6.96C.7 15.12 0 19.46 0 24s.7 8.88 1.94 11.74l8.96-6.96z"/>
        </svg>
      </span>
      <span>Continuă cu Google</span>
    </button>
  </div>
</div>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <img src="imagini-chatgpt/logo.png" alt="Vreau Ajutor">
      <h1>VreauAjutor.ro</h1>
    </div>
    <nav>
      <a href="#">Acasă</a>
      <a href="#">Categorii</a>
      <a href="furnizori.html">Furnizori</a>
      <a href="ofera-servicii.html" class="cta-suppliers">Oferă servicii</a>
      <a href="#">Contact</a>
    </nav>
 <div class="auth-buttons">
  <button id="btnLogin" onclick="openLogin()">Autentificare</button>
  <button id="btnRegister" onclick="openRegister()">Înregistrare</button>
  <a href="ofera-servicii.html" class="link-suppliers">Oferă servicii (pentru firme)</a>
</div>

  </header>
  <!-- HERO SEARCH (bandă albastră deasupra sliderului) -->
<section class="hero-search-band" role="search">
  <form class="hero-search" onsubmit="heroSearch(); return false;">
   <input id="heroQuery" type="search" placeholder="Ex: curățenie Cluj-Napoca"
       aria-label="Caută servicii sau oraș" enterkeyhint="search">
    <button type="submit">Caută</button>
  </form>
</section>



  <!-- SLIDER + SELECTOR -->
  <section class="sectiune-slider-selector"
         data-aos="fade-up"
         data-aos-duration="600"
         data-aos-easing="ease-out-cubic">

    <div class="slider-modern">
      <div class="slider-container">
       <div class="slides" id="slides">
  <!-- Prima imagine: LCP mai rapid -->
  <img src="imagini-chatgpt/curatenie.png" alt="Curățenie"
       loading="eager" fetchpriority="high" decoding="async">

  <!-- Restul: lazy -->
  <img src="imagini-chatgpt/instal.png" alt="Instalator" loading="lazy" decoding="async">
  <img src="imagini-chatgpt/mecanic.png" alt="Mecanic" loading="lazy" decoding="async">
  <img src="imagini-chatgpt/transport.png" alt="Transport" loading="lazy" decoding="async">
  <img src="imagini-chatgpt/bone.png" alt="Bone" loading="lazy" decoding="async">
  <img src="imagini-chatgpt/electricieni.png" alt="Electricieni" loading="lazy" decoding="async">
</div>
         <button class="prev" type="button" aria-label="Slide anterior" onclick="moveSlide(-1)">‹</button>
         <button class="next" type="button" aria-label="Slide următor"  onclick="moveSlide(1)">›</button>
      </div>
    </div>

    <div class="selector-zona">
  <h3>Selectează zona și serviciul:</h3>

  <label for="judet">Județ:</label>
  <select id="judet" aria-label="Județ">
    <option value="" selected>Alege județul</option>
  </select>

  <label for="oras">Oraș:</label>
  <select id="oras" aria-label="Oraș">
    <option value="" selected>Alege orașul</option>
  </select>

  <label for="serviciu">Serviciu:</label>
  <select id="serviciu" aria-label="Serviciu">
    <option value="" selected>Alege serviciul</option>
  </select>
<button
  type="button"
  class="advanced-toggle"
  id="btnAdv"
  aria-expanded="false"
  aria-controls="advanced-panel"
  onclick="toggleAdvanced()">
  Căutare avansată
</button>



<div id="advanced-panel" class="advanced-panel" hidden>
  <label for="price_max">Preț maxim (lei)</label>
  <input type="number" id="price_max" min="0" step="1" inputmode="numeric" placeholder="ex: 300">

  <label for="rating_min">Rating minim</label>
  <select id="rating_min">
    <option value="">Indiferent</option>
    <option value="3">3+</option>
    <option value="4">4+</option>
    <option value="4.5">4.5+</option>
  </select>

  <label class="chk">
    <input type="checkbox" id="available_today"> Disponibil azi
  </label>

  <label class="chk">
    <input type="checkbox" id="has_photos"> Numai cu fotografii
  </label>
  <!-- === Subcategoriile (nivel 1) ale categoriei selectate === -->
<div id="subcat-wrap" class="advanced-panel" style="margin-top:10px;" hidden>
  <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
    <strong>Subcategorii</strong>
    <button type="button" id="reset-subcat" class="advanced-toggle" style="width:auto;padding:4px 10px;">Reset</button>
  </div>
  <div id="subcats" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;"></div>
</div>

<!-- === Sub-subcategoriile copil ale subcategoriei alese === -->
<div id="child-wrap" class="advanced-panel" style="margin-top:10px;" hidden>
  <strong>Sub-subcategorii</strong>
  <div id="children" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;"></div>
</div>

<!-- valori reținute pentru trimitere către furnizori.html -->
<input type="hidden" id="subcat">
<input type="hidden" id="subsub">

</div>
      

  <button type="button" onclick="gotoFurnizori()">Caută</button>
</div>

  </section>

  <!-- SERVICII POPULARE -->
  <section class="servicii-populare"
         data-aos="fade-up"
         data-aos-delay="120"
         data-aos-duration="600">

  <h2>Servicii Populare</h2>
  <div class="servicii-container">
    <div class="serviciu-box">
      <img src="imagini-chatgpt/curatenie.png" alt="Curățenie" loading="lazy" decoding="async">
      <p>Curățenie locuințe, birouri, spații comerciale</p>
    </div>
    <div class="serviciu-box">
      <img src="imagini-chatgpt/instal.png" alt="Instalator" loading="lazy" decoding="async">
      <p>Reparații instalații sanitare, țevi, robineți</p>
    </div>
    <div class="serviciu-box">
      <img src="imagini-chatgpt/electricieni.png" alt="Electrician" loading="lazy" decoding="async">
      <p>Panouri, prize, iluminat, reparații electrice</p>
    </div>
    <div class="serviciu-box">
      <img src="imagini-chatgpt/bone.png" alt="Bone" loading="lazy" decoding="async">
      <p>Îngrijire copii, dus/adus, supraveghere</p>
    </div>
    <div class="serviciu-box">
      <img src="imagini-chatgpt/electrocasnice.png" alt="Electrocasnice" loading="lazy" decoding="async">
      <p>Reparații electrocasnice, frigidere, mașini de spălat</p>
    </div>
  </div>
</section>

  <!-- CUM FUNCȚIONEAZĂ -->
  <section class="cum-functioneaza"
         data-aos="fade-up"
         data-aos-delay="200"
         data-aos-duration="600">

    <h2>Cum funcționează</h2>
    <ol>
      <li>Selectezi județul, orașul și serviciul</li>
      <li>Primești lista firmelor disponibile</li>
      <li>Plasezi comanda sau iei legătura direct</li>
    </ol>
  </section>

  <!-- FOOTER -->
  <footer>
    <p>&copy; 2025 VreauAjutor.ro – Toate drepturile rezervate.</p>
  </footer>

  <!-- AjutorBot – widget plutitor -->
  <div id="ajb-widget" class="minimized">
    <div class="ajb-header" role="button" tabindex="0"
     aria-controls="ajb-panel" aria-expanded="false"
     onclick="toggleAjb()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleAjb();}">
  <span>AjutorBot 🤖</span>
  <span style="margin-left:auto;opacity:.6;font-size:12px;">Click pentru a deschide</span>
</div>

    <div class="ajb-body" id="ajb-panel">
      <div id="ajb-messages" aria-live="polite" aria-atomic="false"></div>
      <div class="ajb-input">
        <input id="ajb-input" type="text" placeholder="Scrie mesajul tău..." onkeydown="if(event.key==='Enter') ajbSend()" />
        <button onclick="ajbSend()">Trimite</button>
      </div>
    </div>
  </div>

  <!-- Scriptul widgetului (endpoints + logica) -->
  <script>
    // Prioritate: ?api=..., altfel default local
    const AJB_API =
  new URLSearchParams(location.search).get('api') ||
  '/chat'; // ← acum lovește funcția Netlify prin redirectul din netlify.toml

    function toggleAjb(){
  const w = document.getElementById('ajb-widget');
  const header = w.querySelector('.ajb-header');
  w.classList.toggle('minimized');
  const expanded = !w.classList.contains('minimized');
  header.setAttribute('aria-expanded', String(expanded));
  if (expanded) {
    setTimeout(() => document.getElementById('ajb-input').focus(), 0);
  }
}


    function ajbAppend(sender, text){
      const box = document.getElementById('ajb-messages');
      const d = document.createElement('div');
      d.style.margin = '6px 0';
      d.innerHTML = '<strong>' + sender + ':</strong> ' + (text || '');
      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
    }

    async function ajbSend(){
      const inp = document.getElementById('ajb-input');
      const txt = (inp.value || '').trim();
      if(!txt) return;
      ajbAppend('Tu', txt);
      inp.value = '';
      try{
        const r = await fetch(AJB_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: txt })
        });
        if (!r.ok) throw new Error('Request failed: ' + r.status + ' ' + r.statusText);
        const data = await r.json();
        ajbAppend('AjutorBot', data.reply ?? 'Răspuns gol de la server.');
      }catch(e){
        console.error(e);
        ajbAppend('AjutorBot', 'Nu pot contacta serverul. Verifică dacă rulează pe http://localhost:3000 și dacă ai pus OPENAI_API_KEY.');
      }
    }
  </script>
<script>
  function toggleAdvanced(){
    const panel = document.getElementById('advanced-panel');
    const btn   = document.getElementById('btnAdv');
    const isHidden = panel.hasAttribute('hidden');
    if (isHidden){
      panel.removeAttribute('hidden');
      btn.setAttribute('aria-expanded','true');
      // focus pe primul câmp când se deschide
      setTimeout(()=> document.getElementById('price_max')?.focus(), 0);
    } else {
      panel.setAttribute('hidden','');
      btn.setAttribute('aria-expanded','false');
    }
  }

  function gotoFurnizori() {
    const judet    = document.getElementById('judet')?.value || '';
    const oras     = document.getElementById('oras')?.value || '';
    const serviciu = document.getElementById('serviciu')?.value || '';
    const subcat = document.getElementById('subcat')?.value || '';
    const subsub = document.getElementById('subsub')?.value || '';
    
    // câmpuri avansate
    const priceMax = document.getElementById('price_max')?.value?.trim() || '';
    const ratingMin= document.getElementById('rating_min')?.value || '';
    const today    = document.getElementById('available_today')?.checked || false;
    const photos   = document.getElementById('has_photos')?.checked || false;

    const params = new URLSearchParams();
    if (judet)    params.set('judet', judet);
    if (oras)     params.set('oras', oras);
    if (serviciu) params.set('service', serviciu);
    if (subcat) params.set('subcat', subcat);
    if (subsub) params.set('subsub', subsub);
    
    // atașăm DOAR ce e completat/bifat
    if (priceMax) params.set('pmax', priceMax);
    if (ratingMin)params.set('rmin', ratingMin);
    if (today)    params.set('today', '1');
    if (photos)   params.set('photos', '1');

    window.location.href = 'furnizori.html' + (params.toString() ? '?' + params.toString() : '');
  }

  // opțional: Enter în câmpurile avansate => pornește căutarea
  ['price_max','rating_min'].forEach(id=>{
    document.getElementById(id)?.addEventListener('keydown', e=>{
      if (e.key === 'Enter') { e.preventDefault(); gotoFurnizori(); }
    });
  });
</script>

  <script>
['judet','oras','serviciu'].forEach(id=>{
  document.getElementById(id)?.addEventListener('keydown', e=>{
    if (e.key === 'Enter') { e.preventDefault(); gotoFurnizori(); }
  });
});
</script>
  <script>
function normalizeRO(s){
  return (s || '')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,''); // scoate diacriticele
}

async function heroSearch(){
  const q = (document.getElementById('heroQuery').value || '').trim();
  if(!q) return;

  try{
    const r = await fetch('/.netlify/functions/lists', { cache:'no-store' });
    const { services = [], judete = [] } = await r.json();

    const nQ = normalizeRO(q);
    const svc = services.find(s => nQ.includes(normalizeRO(s)));
    const jud = judete.find(j => nQ.includes(normalizeRO(j)));

    const params = new URLSearchParams();
    if (svc) params.set('service', svc);
    if (jud) params.set('judet', jud);
    if (!svc && !jud) params.set('service', q);

    location.href = 'furnizori.html' + (params.toString() ? '?' + params.toString() : '');
  }catch(e){
    location.href = 'furnizori.html?service=' + encodeURIComponent(q);
  }
}
</script>

  <script>
document.addEventListener('DOMContentLoaded', async () => {
  let services = [];
  let judete   = [];
  try {
    const r = await fetch('/.netlify/functions/lists', { cache: 'no-store' });
    if (r.ok) {
      const data = await r.json();
      services = Array.isArray(data.services) ? data.services : [];
      judete   = Array.isArray(data.judete)   ? data.judete   : [];
    } else {
      console.warn('lists failed:', r.status, r.statusText);
    }
  } catch (e) {
    console.error('lists error:', e);
  }

  const selServ  = document.getElementById('serviciu');
  const selJudet = document.getElementById('judet');

  services.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name; opt.textContent = name;
    selServ.appendChild(opt);
  });

  judete.forEach(j => {
    const opt = document.createElement('option');
    opt.value = j; opt.textContent = j;
    selJudet.appendChild(opt);
  });

  await reloadActiveServicesByArea({ preserveSelection: false });
});
</script>

  <script>
  // când se schimbă ORAȘUL => refiltrăm serviciile
  document.getElementById('oras')?.addEventListener('change', () => {
    reloadActiveServicesByArea();
  });

  // când se schimbă JUDEȚUL => refacem orașele și refiltrăm serviciile
  document.getElementById('judet').addEventListener('change', async (ev) => {
    const judet = ev.target.value;
    const selOras = document.getElementById('oras');

    selOras.innerHTML = '';
    const first = document.createElement('option');
    first.value = '';
    first.textContent = 'Alege orașul';
    selOras.appendChild(first);

    if (!judet) {
      // dacă s-a șters județul, refiltrăm serviciile pe „toată țara”
      reloadActiveServicesByArea({ preserveSelection: false });
      return;
    }

    try {
      const r = await fetch('/.netlify/functions/lists?judet=' + encodeURIComponent(judet));
      if (!r.ok) throw new Error('Nu pot lua orașele');
      const { orase } = await r.json();
      orase.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o; opt.textContent = o;
        selOras.appendChild(opt);
      });
    } catch (e) { console.error(e); }

    // reîncarcă serviciile disponibile pentru acest județ
    reloadActiveServicesByArea();
  });
</script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- INIT + Google + header greet -->
<script id="auth-init">
  window.supa = null;

  (async () => {
    try {
      const r = await fetch('/.netlify/functions/spa_env', { cache:'no-store' });
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = await r.json();
      window.supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Google
      document.getElementById('googleSignIn')?.addEventListener('click', async () => {
        await window.supa.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin + '/auth-callback.html' }
        });
      });

      // Afișează "Salut, email" + buton de Ieșire
      const { data:{ user } } = await window.supa.auth.getUser();
      if (user) {
        const box = document.querySelector('.auth-buttons');
        if (box) {
          // dacă vrei să ascunzi butoanele, adaugă ID-uri în HTML: id="btnLogin" și id="btnRegister"
          document.getElementById('btnLogin')?.remove();
          document.getElementById('btnRegister')?.remove();

          const hi = document.createElement('div');
          hi.style.fontSize = '13px'; hi.style.opacity = '.9';
          hi.textContent = `Salut, ${user.email}`;

          const out = document.createElement('button');
          out.textContent = 'Ieșire';
          out.style.padding = '6px 10px';
          out.onclick = async () => { await window.supa.auth.signOut(); location.reload(); };

          box.append(hi, out);
        }
      }
    } catch(e) { console.error('ENV load failed', e); }
  })();
</script>

<!-- Email/parolă – folosite de butoanele din modal -->
<script id="auth-email-pass">
  async function inregistrare(){
    const email = document.getElementById('register_email')?.value?.trim();
    const pass  = document.getElementById('register_password')?.value?.trim();
    if (!window.supa) return alert('Auth indisponibil');
    if (!email || !pass) return alert('Completează email + parolă');

    const { error } = await window.supa.auth.signUp({ email, password: pass });
    if (error) return alert('Eroare: ' + error.message);
    alert('Cont creat! Verifică email-ul pentru confirmare.');
    document.getElementById('authModal').style.display = 'none';
  }

  async function autentificare(){
    const email = document.getElementById('login_email')?.value?.trim();
    const pass  = document.getElementById('login_password')?.value?.trim();
    if (!window.supa) return alert('Auth indisponibil');
    if (!email || !pass) return alert('Completează email + parolă');

    const { error } = await window.supa.auth.signInWithPassword({ email, password: pass });
    if (error) return alert('Eroare: ' + error.message);
    alert('Autentificat!');
    document.getElementById('authModal').style.display = 'none';
    location.reload();
  }
</script>
  <script>
  // mic helper
  async function ajx(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }

  function renderChips(container, items, onClick){
    container.innerHTML = '';
    (items || []).forEach(it => {
      const b = document.createElement('button');
      b.type = 'button';
      b.textContent = it.name + (it.count ? ` (${it.count})` : '');
      b.title = it.name;
      b.style.cssText = 'padding:6px 10px;border:1px solid #ccc;border-radius:999px;background:#fff;cursor:pointer;';
      b.addEventListener('click', () => onClick(it));
      container.appendChild(b);
    });
  }

  async function loadSubcatsForSelectedService() {
    const service = document.getElementById('serviciu')?.value || '';
    const judet   = document.getElementById('judet')?.value || '';
    const oras    = document.getElementById('oras')?.value || '';
    const wrap    = document.getElementById('subcat-wrap');
    const cont    = document.getElementById('subcats');
    const childW  = document.getElementById('child-wrap');
    const hidSub  = document.getElementById('subcat');
    const hidKid  = document.getElementById('subsub');

    // reset
    hidSub.value = ''; hidKid.value = '';
    childW.hidden = true; document.getElementById('children').innerHTML = '';
    if (!service){ wrap.hidden = true; cont.innerHTML = ''; return; }

    const url = '/.netlify/functions/taxonomy?mode=subcategories'
              + '&service=' + encodeURIComponent(service)
              + (judet ? '&judet='+encodeURIComponent(judet) : '')
              + (oras  ? '&oras=' +encodeURIComponent(oras)  : '');
    try{
      const { subcategories = [] } = await ajx(url);
      if (!subcategories.length){ wrap.hidden = true; cont.innerHTML = ''; return; }
      wrap.hidden = false;
      renderChips(cont, subcategories, (item) => {
        hidSub.value = item.id;   // setăm subcategoria aleasă
        hidKid.value = '';        // resetăm copilul
        loadChildrenForSubcat(item.id);
      });
    }catch(e){
      console.error(e);
      wrap.hidden = true;
    }
  }

  async function loadChildrenForSubcat(subcatId){
    const judet  = document.getElementById('judet')?.value || '';
    const oras   = document.getElementById('oras')?.value || '';
    const wrap   = document.getElementById('child-wrap');
    const cont   = document.getElementById('children');
    const hidKid = document.getElementById('subsub');

    const url = '/.netlify/functions/taxonomy?mode=children&subcat='+encodeURIComponent(subcatId)
              + (judet ? '&judet='+encodeURIComponent(judet) : '')
              + (oras  ? '&oras=' +encodeURIComponent(oras)  : '');

    try{
      const { children = [] } = await ajx(url);
      if (!children.length){ wrap.hidden = true; cont.innerHTML = ''; return; }
      wrap.hidden = false;
      renderChips(cont, children, (kid) => { hidKid.value = kid.id; });
    }catch(e){
      console.error(e);
      wrap.hidden = true;
    }
  }

  // când se deschide panoul avansat, dacă există categorie selectată, încarcă subcategoriile
  const _oldToggleAdvanced = window.toggleAdvanced;
  window.toggleAdvanced = function(){
    _oldToggleAdvanced();
    const panelNowOpen = !document.getElementById('advanced-panel').hasAttribute('hidden');
    if (panelNowOpen) loadSubcatsForSelectedService();
  };

  // la schimbarea categoriei, refa subcategoriile
  document.getElementById('serviciu')?.addEventListener('change', loadSubcatsForSelectedService);

  // buton „Reset” subcategorii
  document.getElementById('reset-subcat')?.addEventListener('click', () => {
    document.getElementById('subcat').value = '';
    document.getElementById('subsub').value = '';
    document.getElementById('child-wrap').hidden = true;
    document.getElementById('children').innerHTML = '';
  });
</script>
  <script>
  // mic helper deja definit mai sus:
  // async function ajx(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }

  async function reloadActiveServicesByArea({ preserveSelection = true } = {}) {
    const judet   = document.getElementById('judet')?.value || '';
    const oras    = document.getElementById('oras')?.value || '';
    const selServ = document.getElementById('serviciu');

    if (!selServ) return;

    const prev = preserveSelection ? selServ.value : '';

    // UI: loading state
    selServ.disabled = true;
    selServ.innerHTML = '<option value="">Se încarcă…</option>';

    try {
      const url = '/.netlify/functions/taxonomy?mode=categories'
                + (judet ? '&judet=' + encodeURIComponent(judet) : '')
                + (oras  ? '&oras='  + encodeURIComponent(oras)  : '');
      const { services = [] } = await ajx(url);

      // reumple selectorul
      selServ.innerHTML = '<option value="">Alege serviciul</option>';
      services.forEach(s => {
        const val = (typeof s === 'string') ? s : (s.name || '');
        if (!val) return;
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        selServ.appendChild(opt);
      });

      // păstrează selecția dacă mai e validă; altfel resetează și ascunde sub-panourile
      if (prev && [...selServ.options].some(o => o.value === prev)) {
        selServ.value = prev;
      } else {
        selServ.value = '';
        // reset subcat/subsub + UI
        document.getElementById('subcat').value = '';
        document.getElementById('subsub').value = '';
        document.getElementById('subcat-wrap').hidden = true;
        document.getElementById('child-wrap').hidden  = true;
        document.getElementById('subcats').innerHTML  = '';
        document.getElementById('children').innerHTML = '';
      }

      // dacă panoul avansat e deschis și există serviciu selectat -> reîncarcă subcategoriile
      const panelOpen = !document.getElementById('advanced-panel').hasAttribute('hidden');
      if (panelOpen && selServ.value) {
        await loadSubcatsForSelectedService();
      }
    } catch (e) {
      console.error('taxonomy categories error', e);
      selServ.innerHTML = '<option value="">Alege serviciul</option>';
    } finally {
      selServ.disabled = false;
    }
  }
  
</script>

</body>
</html>
