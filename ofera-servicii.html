<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Înscriere furnizor • VreauAjutor.ro</title>

  <!-- CSS global site -->
  <link rel="stylesheet" href="./style.css"/>
  <!-- CSS scoped pentru pagina aceasta -->
  <link rel="stylesheet" href="./assets/css/offer.css?v=3"/>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Wrapper pentru stiluri scoped: tot conținutul paginii stă în .offer -->
  <div class="offer">
    <main class="wrap">
      <h1>Înscriere furnizor</h1>
      <div class="subtitle">Completează datele, verifică telefonul și emailul, apoi trimite.</div>

      <form id="f" novalidate>
        <section class="grid-3">
          <!-- 1) Detalii furnizor -->
          <div class="card">
            <h3 style="margin:4px 0 10px;">Detalii furnizor</h3>

            <label for="company_name">Companie *</label>
            <input id="company_name" required/>

            <label for="service_name">Serviciu *</label>
            <select id="service_name" required>
              <option value="">Alege serviciul</option>
            </select>

            <label for="reg_judet">Județ *</label>
            <select id="reg_judet" required>
              <option value="">Alege județul</option>
            </select>

            <label for="reg_oras">Oraș *</label>
            <select id="reg_oras" required disabled>
              <option value="">Alege orașul</option>
            </select>

            <div style="margin-top:6px"></div>

            <label>Telefon *</label>
            <div class="row">
              <input id="phone" class="grow" placeholder="07..." inputmode="tel"/>
              <button type="button" id="smsSend" class="btn-chip" disabled>Trimite cod</button>
            </div>
            <div class="otp-wrap">
              <input id="smsCode" class="code6" maxlength="6" placeholder="cod 6 cifre" inputmode="numeric" disabled/>
              <button type="button" id="smsVerify" class="btn-chip" disabled>Verifică</button>
              <span id="smsState" class="hint-warn">Neînceput</span>
              <span id="smsDot" class="status-dot st-amber" aria-hidden="true"></span>
            </div>

            <label style="margin-top:12px;">Email *</label>
            <div class="row">
              <input id="email" class="grow" type="email" placeholder="contact@..."/>
              <button type="button" id="emlSend" class="btn-chip" disabled>Trimite cod</button>
            </div>
            <div class="otp-wrap">
              <input id="emlCode" class="code6" maxlength="6" placeholder="cod 6 cifre" inputmode="numeric" disabled/>
              <button type="button" id="emlVerify" class="btn-chip" disabled>Verifică</button>
              <span id="emlState" class="hint-warn">Neînceput</span>
              <span id="emlDot" class="status-dot st-amber" aria-hidden="true"></span>
            </div>

            <label for="description" style="margin-top:12px;">Descriere</label>
            <textarea id="description" rows="4" placeholder="Ce servicii oferiți, zone acoperite..."></textarea>

            <div class="actions">
              <button type="button" class="btn-outline" onclick="history.back()">Înapoi</button>
              <button id="submitBtn" type="submit" disabled>Trimite</button>
            </div>
            <div class="msg" id="msg" role="status" aria-live="polite"></div>
          </div>

          <!-- 2) Subcategorii – CASCADER în 2 coloane (stânga: subcategorii, dreapta: copii) -->
          <div class="card">
            <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
              <h3 style="margin:4px 0;">Subcategorii</h3>
              <div class="row">
                <button type="button" id="subcat-toggle" class="btn-chip">Restrânge</button>
                <button type="button" id="subcat-reset" class="btn-chip">Reset</button>
              </div>
            </div>

            <div class="cascader">
              <!-- Subcategorii (nivel 1) -->
              <section class="pane">
                <div class="pane-title">Nivel 1</div>
                <div id="subcats" class="pane-body"></div>
              </section>

              <!-- Copii (nivel 2) -->
              <section class="pane" id="child-wrap" aria-live="polite">
                <div class="pane-title">
                  Nivel 2
                  <div class="tools" style="float:right;display:flex;gap:8px;align-items:center;">
                    <button type="button" class="btn-chip" id="children-collapse-all">Restrânge toate</button>
                    <button type="button" class="btn-chip" id="children-expand-all">Extinde toate</button>
                    <small id="min1-hint" class="hint-danger" style="display:none;margin-left:6px;">Selectează cel puțin una</small>
                  </div>
                </div>
                <div id="children" class="pane-body"></div>
              </section>
            </div>

            <!-- hidden pentru backend (rămân neschimbate) -->
            <input type="hidden" id="subcat">
            <input type="hidden" id="subcat_name">
            <input type="hidden" id="subsub">
          </div>

          <!-- 3) (slotul al treilea din grid rămâne liber pentru viitoare extensii / media) -->
          <div class="card" style="display:none"></div>
        </section>
      </form>
    </main>
  </div> <!-- end .offer -->

  <!-- ======================== Helpers liste (services/judete/orase) ======================== -->
  <script>
    function fillSelect(sel, arr, firstLabel) {
      sel.innerHTML = '';
      const first = document.createElement('option');
      first.value = ''; first.textContent = firstLabel; sel.appendChild(first);
      (arr||[]).forEach(v=>{
        const name  = typeof v==='string' ? v : (v.name||v.label||v.text||'');
        const value = typeof v==='string' ? v : (v.value||v.name||v.id||'');
        if (!name) return;
        const o=document.createElement('option'); o.value=value; o.textContent=name; sel.appendChild(o);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const r = await fetch('/.netlify/functions/lists?mode=signup', { cache:'no-store' });
        const { services=[], judete=[] } = await r.json();

        const selServ = document.getElementById('service_name');
        const selJ = document.getElementById('reg_judet');
        const selO = document.getElementById('reg_oras');

        fillSelect(selServ, services, 'Alege serviciul');
        fillSelect(selJ, judete,  'Alege județul');
        fillSelect(selO, [],      'Alege orașul'); selO.disabled=true;

        // NU mai resetăm selecțiile la schimbarea județ/oras
        selJ.addEventListener('change', async (ev)=>{
          const judet=ev.target.value;
          fillSelect(selO, [], 'Alege orașul'); selO.disabled=true;
          if (judet) {
            const rr = await fetch('/.netlify/functions/lists?mode=signup&judet='+encodeURIComponent(judet), {cache:'no-store'});
            const { orase=[] } = await rr.json();
            fillSelect(selO, orase, 'Alege orașul'); selO.disabled=false;
          }
          updateSubmitState();
        });

        selO.addEventListener('change', ()=>{ updateSubmitState(); });

        // Reset DOAR când se schimbă serviciul
        selServ.addEventListener('change', ()=>{ resetForServiceChange(); loadSubcatsForSignup(); updateSubmitState(); });

        if (!selServ.value && services.length){ selServ.value = services[0].name || services[0]; loadSubcatsForSignup(); }
      } catch(e){ console.error(e); }
    });
  </script>

  <!-- ======================== Supabase + Submit înscriere ======================== -->
  <script>
  (async () => {
    const envRes = await fetch('/.netlify/functions/spa_env', { cache:'no-store' });
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = await envRes.json();
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.getElementById('f').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if (document.getElementById('submitBtn').disabled) return;

      const form=ev.target, btn=document.getElementById('submitBtn');
      const originalLabel=btn.textContent;
      btn.disabled=true; btn.textContent='Se trimite...';
      const msg=document.getElementById('msg'); msg.className='msg'; msg.textContent='Trimit...';

      const { data:{session} } = await supa.auth.getSession();
      if (!session?.access_token){
        msg.classList.add('hint-danger'); msg.textContent='Trebuie să fii autentificat (butonul „Autentificare”).';
        btn.disabled=false; btn.textContent=originalLabel; return;
      }

      const selectedChildIds = Array.from(__sel.bySub.values())
        .flatMap(s => Array.from(s))
        .map(v => Number(v))
        .filter(n => Number.isFinite(n));

      const payload = {
        company_name: document.getElementById('company_name').value.trim(),
        service_name: document.getElementById('service_name').value,
        judet:        document.getElementById('reg_judet').value,
        oras:         document.getElementById('reg_oras').value,
        phone:        document.getElementById('phone').value,
        email:        document.getElementById('email').value,
        description:  document.getElementById('description').value,
        subcat:       document.getElementById('subcat').value || null,
        subcat_name:  document.getElementById('subcat_name').value || null,
        subsub:       document.getElementById('subsub').value || null,
        subsubs:      selectedChildIds,
        phone_verified: window.__otp?.phoneVerified || false,
        email_verified: window.__otp?.emailVerified || false
      };

      try{
        const r = await fetch('/.netlify/functions/register_provider', {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+session.access_token},
          body:JSON.stringify(payload)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Eroare necunoscută');
        msg.classList.add('hint-ok'); msg.textContent='Înscriere reușită! Mulțumim.';
        form.reset(); document.getElementById('reg_oras').disabled=true;
        document.getElementById('children').innerHTML='';
        __sel.bySub.clear(); __subMeta.clear(); __cacheChildren.clear();
        resetOtpUI();
        updateSubmitState();
      }catch(e){
        msg.classList.add('hint-danger'); msg.textContent='Eroare: '+e.message;
      }finally{
        btn.disabled=false; btn.textContent=originalLabel;
      }
    });
  })();
  </script>

  <!-- ======================== Taxonomy (subcategorii & copii) + OTP ======================== -->
  <script>
    // --- State central ---
    const __sel = { bySub: new Map() };   // subId/name -> Set(childIds as strings)
    const __subMeta = new Map();          // subId/name -> {btn, name, badge}
    const __cacheChildren = new Map();    // subId/name -> children[]

    // --- Utils ---
    async function ajx(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

    // setează vizualul pt un singur subId
    function updateChipVisuals(subKey){
      const meta = __subMeta.get(subKey);
      if (!meta) return;
      const size = (__sel.bySub.get(subKey)?.size || 0);
      meta.btn.classList.toggle('blue', size > 0);
      if (meta.badge) meta.badge.textContent = String(size);
    }

    // reface vizualul pentru TOATE chip-urile
    function applyBlueFromState(){
      for (const [subKey, meta] of __subMeta.entries()){
        const size = (__sel.bySub.get(subKey)?.size || 0);
        meta.btn.classList.toggle('blue', size > 0);
        if (meta.badge) meta.badge.textContent = String(size);
      }
    }

    function syncHiddenFromState(){
      const ids=[], names=[];
      for (const [key,set] of __sel.bySub.entries()){
        if (!set.size) continue;
        const meta = __subMeta.get(key) || {};
        if (Number.isInteger(key)) ids.push(String(key));
        else names.push(meta.name || String(key));
      }
      document.getElementById('subcat').value = ids.join(',');
      document.getElementById('subcat_name').value = names.join(',');
      const firstKid = Array.from(__sel.bySub.values()).flatMap(s=>Array.from(s))[0];
      document.getElementById('subsub').value = firstKid ? String(firstKid) : '';
      updateSubmitState();
    }

    function renderChips(container, items){
      container.innerHTML=''; __subMeta.clear();
      items.forEach(it=>{
        const id = (it.id!=null) ? Number(it.id) : (it.name || '');
        const name = it.name ?? '';

        const btn = document.createElement('button');
        btn.type='button'; btn.className='chip';
        const title = document.createElement('span'); title.textContent=name;
        const badge = document.createElement('span'); badge.className='badge'; badge.textContent='0';
        btn.appendChild(title); btn.appendChild(badge);

        __subMeta.set(id,{btn,name,badge});
        btn.addEventListener('click', async ()=>{
          // active în coloana stângă
          container.querySelectorAll('.chip').forEach(b=>b.classList.remove('active','blue'));
          btn.classList.add('active','blue');

          // reset copii pentru subcat selectată
          const childC = document.getElementById('children');
          childC.innerHTML='';

          // încărcăm copii
          await loadChildrenForSubcat(id);
        });
        container.appendChild(btn);
      });

      // colorează corect pe baza selecțiilor existente
      applyBlueFromState();
    }

    function resyncChildCheckboxes(subKey){
      const group = document.getElementById('children');
      if (!group) return;
      const set = __sel.bySub.get(subKey) || new Set();
      group.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.checked = set.has(String(cb.value));
        cb.closest('.child-item')?.classList.toggle('on', cb.checked);
      });
      updateChipVisuals(subKey);
      applyBlueFromState();
      updateSubmitState();
    }

    async function loadChildrenForSubcat(subKey){
      const meta = __subMeta.get(subKey) || {};
      const subParam = Number.isInteger(subKey) ? String(subKey) : (meta.name || String(subKey));
      const url = '/.netlify/functions/taxonomy?mode=children&subcat='+encodeURIComponent(subParam);

      let children = [];
      try{
        const { children: list=[] } = await ajx(url);
        children = list;
      }catch(e){ console.error(e); }

      // render în #children
      const cont = document.getElementById('children');
      cont.innerHTML = '';
      const selectedSet = __sel.bySub.get(subKey) || new Set();

      children.forEach(kid=>{
        const safeKey = (kid.id != null) ? String(kid.id) : ('n_' + (kid.name || '').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,''));
        const inputId = `kid_${safeKey}`;

        const lab = document.createElement('label'); lab.className = 'child-item'; lab.setAttribute('for', inputId);

        const cb  = document.createElement('input'); cb.type='checkbox'; cb.id=inputId;
        cb.value  = (kid.id != null) ? String(kid.id) : (kid.name || '');
        cb.checked = selectedSet.has(String(cb.value));
        if (cb.checked) lab.classList.add('on');

        cb.addEventListener('change', ()=>{
          let set = __sel.bySub.get(subKey);
          if (!set){ set = new Set(); __sel.bySub.set(subKey, set); }

          const val = String(cb.value);
          if (cb.checked) set.add(val); else set.delete(val);
          if (set.size === 0) __sel.bySub.delete(subKey);

          lab.classList.toggle('on', cb.checked);

          // reflectă chip-ul + badge
          updateChipVisuals(subKey);
          // sincronizează hidden fields
          syncHiddenFromState();
          // forțează culoarea pe toate chip-urile
          applyBlueFromState();

          if (Array.from(__sel.bySub.values()).some(s => s.size > 0)){
            document.getElementById('min1-hint').style.display = 'none';
          }
        });

        lab.appendChild(cb);
        lab.appendChild(document.createTextNode(kid.name + (kid.count ? ` (${kid.count})` : '')));
        cont.appendChild(lab);
      });

      // setează hidden-urile pentru nivelul 1 selectat
      document.getElementById('subcat').value = Number.isInteger(subKey) ? String(subKey) : '';
      document.getElementById('subcat_name').value = meta.name || (Number.isInteger(subKey) ? '' : String(subKey));

      resyncChildCheckboxes(subKey);
    }

    // Încarcă subcategoriile DOAR după serviciu (fără judet/oras)
    async function loadSubcatsForSignup(){
      const service = document.getElementById('service_name')?.value || '';
      const cont    = document.getElementById('subcats');
      const childC  = document.getElementById('children');

      // reset
      document.getElementById('subcat').value='';
      document.getElementById('subcat_name').value='';
      document.getElementById('subsub').value='';
      __sel.bySub.clear(); __subMeta.clear(); __cacheChildren.clear();
      childC.innerHTML='';

      if (!service){
        cont.innerHTML='Alege un serviciu mai sus.';
        updateSubmitState(); return;
      }

      const url = '/.netlify/functions/taxonomy?mode=subcategories'
                + '&service=' + encodeURIComponent(service);

      try{
        const { subcategories=[] } = await ajx(url);
        if (!subcategories.length){
          cont.innerHTML='Nu există subcategorii.';
          updateSubmitState(); return;
        }
        renderChips(cont, subcategories);
      }catch(e){ console.error(e); cont.innerHTML=''; }
      updateSubmitState();
    }

    // Reset DOAR când se schimbă serviciul
    function resetForServiceChange(){
      document.getElementById('subcat').value='';
      document.getElementById('subcat_name').value='';
      document.getElementById('subsub').value='';
      __sel.bySub.clear(); __subMeta.clear(); __cacheChildren.clear();
      const childC  = document.getElementById('children');
      childC.innerHTML = '';
      const cont = document.getElementById('subcats');
      cont.innerHTML = '';
    }

    // --- OTP + gating buton Trimite ---
    window.__otp = { phoneVerified:false, emailVerified:false };

    const el = {
      phone:   document.getElementById('phone'),
      email:   document.getElementById('email'),
      smsSend: document.getElementById('smsSend'),
      smsCode: document.getElementById('smsCode'),
      smsVerify: document.getElementById('smsVerify'),
      smsState: document.getElementById('smsState'),
      smsDot:   document.getElementById('smsDot'),
      emlSend: document.getElementById('emlSend'),
      emlCode: document.getElementById('emlCode'),
      emlVerify: document.getElementById('emlVerify'),
      emlState: document.getElementById('emlState'),
      emlDot:   document.getElementById('emlDot'),
      submit: document.getElementById('submitBtn'),
      company: document.getElementById('company_name'),
      service: document.getElementById('service_name'),
      judet: document.getElementById('reg_judet'),
      oras: document.getElementById('reg_oras'),
    };

    function normalizeRO(p){ const s=(p||'').replace(/\s+/g,''); if(/^07\d{8}$/.test(s)) return '+4'+s; if(/^\+?4\d{9,12}$/.test(s)) return s.startsWith('+')?s:'+'+s; return s; }
    function validPhone(p){ return /^07\d{8}$/.test((p||'').replace(/\s+/g,'')) || /^\+4\d{9,12}$/.test((p||'').replace(/\s+/g,'')); }
    function validEmail(x){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(x||''); }

    function setSmsState(t, kind='warn'){
      el.smsState.textContent=t;
      el.smsDot.className='status-dot '+(kind==='ok'?'st-green':kind==='err'?'st-red':'st-amber');
    }
    function setEmlState(t, kind='warn'){
      el.emlState.textContent=t;
      el.emlDot.className='status-dot '+(kind==='ok'?'st-green':kind==='err'?'st-red':'st-amber');
    }

    async function startOtp(channel, to){
      const r = await fetch('/.netlify/functions/otp_start', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ channel, to })
      });
      let data={}; try{ data = await r.json(); }catch(_){}
      if (!r.ok || data.ok!==true) throw new Error(data.error||'Nu am putut trimite codul');
      return true;
    }
    async function verifyOtp(channel, to, code){
      const r = await fetch('/.netlify/functions/otp_verify', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ channel, to, code })
      });
      let data={}; try{ data = await r.json(); }catch(_){}
      if (!r.ok || data.ok!==true) throw new Error(data.error||'Cod invalid');
      return true;
    }

    function resetOtpUI(){
      __otp.phoneVerified=false; __otp.emailVerified=false;
      el.smsSend.disabled = !validPhone(el.phone.value);
      el.smsCode.value=''; el.smsCode.disabled=true; el.smsVerify.disabled=true; setSmsState('Neînceput','warn');
      el.emlSend.disabled = !validEmail(el.email.value);
      el.emlCode.value=''; el.emlCode.disabled=true; el.emlVerify.disabled=true; setEmlState('Neînceput','warn');
      updateSubmitState();
    }

    el.phone.addEventListener('input', ()=>{
      __otp.phoneVerified=false;
      el.smsSend.disabled = !validPhone(el.phone.value);
      el.smsCode.disabled = true; el.smsVerify.disabled = true; setSmsState('Neînceput','warn');
      updateSubmitState();
    });
    el.email.addEventListener('input', ()=>{
      __otp.emailVerified=false;
      el.emlSend.disabled = !validEmail(el.email.value);
      el.emlCode.disabled = true; el.emlVerify.disabled = true; setEmlState('Neînceput','warn');
      updateSubmitState();
    });

    el.smsSend.addEventListener('click', async ()=>{
      try{
        el.smsSend.disabled=true;
        setSmsState('Trimit...', 'warn');
        await startOtp('sms', normalizeRO(el.phone.value));
        setSmsState('Trimis. Verifică SMS.', 'warn');
        el.smsCode.disabled=false; el.smsVerify.disabled=false; el.smsCode.focus();
      }catch(e){ setSmsState(e.message||'Eroare trimitere', 'err'); }
      finally{ el.smsSend.disabled = !validPhone(el.phone.value); }
    });

    el.emlSend.addEventListener('click', async ()=>{
      try{
        el.emlSend.disabled=true;
        setEmlState('Trimit...', 'warn');
        await startOtp('email', (el.email.value||'').trim());
        setEmlState('Trimis. Verifică email.', 'warn');
        el.emlCode.disabled=false; el.emlVerify.disabled=false; el.emlCode.focus();
      }catch(e){ setEmlState('Eroare trimitere', 'err'); }
      finally{ el.emlSend.disabled = !validEmail(el.email.value); }
    });

    el.smsVerify.addEventListener('click', async ()=>{
      try{
        el.smsVerify.disabled=true;
        setSmsState('Verific...', 'warn');
        await verifyOtp('sms', normalizeRO(el.phone.value), (el.smsCode.value||'').trim());
        __otp.phoneVerified=true; setSmsState('Verificat', 'ok'); el.smsCode.disabled=true;
      }catch(e){ setSmsState(e.message||'Cod invalid', 'err'); }
      finally{ el.smsVerify.disabled=false; updateSubmitState(); }
    });

    el.emlVerify.addEventListener('click', async ()=>{
      try{
        el.emlVerify.disabled=true;
        setEmlState('Verific...', 'warn');
        await verifyOtp('email', (el.email.value||'').trim(), (el.emlCode.value||'').trim());
        __otp.emailVerified=true; setEmlState('Verificat', 'ok'); el.emlCode.disabled=true;
      }catch(e){ setEmlState(e.message||'Cod invalid', 'err'); }
      finally{ el.emlVerify.disabled=false; updateSubmitState(); }
    });

    // gating buton Trimite
    function hasAnyKid(){ return Array.from(__sel.bySub.values()).some(s=>s.size>0); }
    function updateSubmitState(){
      const okCompany = (el.company.value||'').trim().length>1;
      const okService = !!el.service.value;
      const okJudet   = !!el.judet.value;
      const okOras    = !!el.oras.value;
      const okKids    = hasAnyKid();
      const okPhoneV  = validPhone(el.phone.value) && __otp.phoneVerified;
      const okEmailV  = validEmail(el.email.value) && __otp.emailVerified;
      const allOk = okCompany && okService && okJudet && okOras && okKids && okPhoneV && okEmailV;

      el.submit.disabled = !allOk;
      el.submit.style.background = allOk ? 'var(--va-primary)' : '#8592a3';
    }

    ['input','change'].forEach(evt=>{
      document.getElementById('company_name').addEventListener(evt, updateSubmitState);
      document.getElementById('service_name').addEventListener(evt, updateSubmitState);
      document.getElementById('reg_judet').addEventListener(evt, updateSubmitState);
      document.getElementById('reg_oras').addEventListener(evt, updateSubmitState);
    });

    // init OTP buttons
    resetOtpUI();
  </script>
</body>
</html>