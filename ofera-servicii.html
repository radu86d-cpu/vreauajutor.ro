<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Înscriere furnizor • VreauAjutor.ro</title>

  <!-- CSS global site -->
  <link rel="stylesheet" href="./style.css"/>
  <!-- CSS scoped pentru pagina aceasta -->
  <link rel="stylesheet" href="./assets/css/offer.css?v=4"/>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- GATE: blochează accesul dacă nu ești autentificat -->
  <script>
    (async () => {
      try {
        const envRes = await fetch('/.netlify/functions/spa_env', { cache: 'no-store' });
        const { SUPABASE_URL, SUPABASE_ANON_KEY } = await envRes.json();
        const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { data:{ session } } = await supa.auth.getSession();
        if (!session) {
          const back = encodeURIComponent(location.pathname + location.search);
          location.replace('/index.html?authRequired=1&redirect=' + back);
        }
      } catch (e) {
        console.error('Auth gate error:', e);
        const back = encodeURIComponent(location.pathname + location.search);
        location.replace('/index.html?authRequired=1&redirect=' + back);
      }
    })();
  </script>
</head>
<body>
  <div class="offer">
    <main class="wrap">
      <h1>Înscriere furnizor</h1>
      <div class="subtitle">Completează datele, verifică telefonul și emailul, apoi trimite.</div>

      <form id="f" novalidate>
        <section class="grid-3">
          <!-- 1) Detalii furnizor -->
          <div class="card">
            <h3 style="margin:4px 0 10px;">Detalii furnizor</h3>

            <label for="company_name">Companie *</label>
            <input id="company_name" required/>

            <label for="service_name">Serviciu *</label>
            <select id="service_name" required>
              <option value="">Alege serviciul</option>
            </select>

            <label for="reg_judet">Județ *</label>
            <select id="reg_judet" required>
              <option value="">Alege județul</option>
            </select>

            <label for="reg_oras">Oraș *</label>
            <select id="reg_oras" required disabled>
              <option value="">Alege orașul</option>
            </select>

            <div style="margin-top:6px"></div>

            <label>Telefon *</label>
            <div class="row">
              <input id="phone" class="grow" placeholder="07..." inputmode="tel" autocomplete="tel"/>
              <button type="button" id="smsSend" class="btn-chip" disabled>Trimite cod</button>
            </div>
            <div class="otp-wrap">
              <input id="smsCode" class="code6" maxlength="6" placeholder="cod 6 cifre" inputmode="numeric" disabled/>
              <button type="button" id="smsVerify" class="btn-chip" disabled>Verifică</button>
              <span id="smsState" class="hint-warn">Neînceput</span>
              <span id="smsDot" class="status-dot st-amber" aria-hidden="true"></span>
            </div>

            <label style="margin-top:12px;">Email *</label>
            <div class="row">
              <input id="email" class="grow" type="email" placeholder="contact@..." autocomplete="email"/>
              <button type="button" id="emlSend" class="btn-chip" disabled>Trimite cod</button>
            </div>
            <div class="otp-wrap">
              <input id="emlCode" class="code6" maxlength="6" placeholder="cod 6 cifre" inputmode="numeric" disabled/>
              <button type="button" id="emlVerify" class="btn-chip" disabled>Verifică</button>
              <span id="emlState" class="hint-warn">Neînceput</span>
              <span id="emlDot" class="status-dot st-amber" aria-hidden="true"></span>
            </div>

            <label for="description" style="margin-top:12px;">Descriere</label>
            <textarea id="description" rows="4" placeholder="Ce servicii oferiți, zone acoperite..."></textarea>

            <div class="actions">
              <button type="button" class="btn-ghost" onclick="history.back()">Înapoi</button>
              <button id="submitBtn" type="submit" class="btn btn-primary" disabled>Trimite</button>
            </div>
            <div class="msg" id="msg" role="status" aria-live="polite"></div>
          </div>

          <!-- 2) Subcategorii -->
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <h3 style="margin:4px 0;">Subcategorii</h3>
              <div class="row">
                <button type="button" id="subcat-toggle" class="btn-chip">Restrânge</button>
                <button type="button" id="subcat-reset" class="btn-chip">Reset</button>
              </div>
            </div>
            <div id="subcats"></div>
            <!-- hidden pentru backend -->
            <input type="hidden" id="subcat">
            <input type="hidden" id="subcat_name">
            <input type="hidden" id="subsub">
          </div>

          <!-- 3) Copii -->
          <div class="card" id="child-wrap" hidden aria-live="polite">
            <div class="child-title">
              <span>Sub-subcategorii (bifează minim 1)</span>
              <div class="tools">
                <button type="button" class="btn-chip" id="children-collapse-all">Restrânge toate</button>
                <button type="button" class="btn-chip" id="children-expand-all">Extinde toate</button>
                <small id="min1-hint" class="hint-danger" style="display:none;margin-left:6px;">Selectează cel puțin una</small>
              </div>
            </div>
            <div id="children"></div>
          </div>
        </section>
      </form>
    </main>
  </div> <!-- end .offer -->

  <!-- ========== Scripturi logice (lists.js, taxonomy.js, OTP) ========== -->
  <script src="./assets/js/ofera-servicii.js"></script>
</body>
</html>